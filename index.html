<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô V16.1 (Adjust Cash)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f9ff; padding-bottom: 120px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.2rem; text-align: center; }
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.4rem; font-size: 1rem; text-align: center; font-weight: 500; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px solid #bfdbfe; }
        .section-header { font-size: 1.1rem; font-weight: bold; color: #0f172a; margin-bottom: 0.8rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; }
        
        .stock-grid { display: grid; grid-template-columns: 1fr 1.5fr 1.5fr 1.5fr; gap: 4px; align-items: end; margin-bottom: 8px; }
        .dual-input { display: flex; gap: 2px; }
        .dual-input input { width: 50%; font-size: 0.9rem; }
        
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .img-preview-box { display: none; margin-top: 5px; text-align: center; background: #e2e8f0; border-radius: 8px; padding: 4px; position: relative; }
        .img-preview-box img { max-height: 120px; max-width: 100%; border-radius: 4px; border: 2px solid white; display: inline-block; }
        .close-btn { background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; position: absolute; top: -5px; right: -5px; cursor: pointer; line-height: 20px; font-size: 12px; }

        .audit-pass { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .audit-fail { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        #connectionStatus { font-size: 0.8rem; padding: 4px 12px; border-radius: 20px; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; }
        .status-online { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-offline { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    </style>
</head>
<body class="p-3 max-w-xl mx-auto">

    <div class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">ü•ü ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô V16.1</h1>
            <p id="saveStatus" class="text-xs text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>
        <div class="flex flex-col items-end gap-1">
            <div id="connectionStatus" class="status-online">
                <span class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            </div>
            <button onclick="clearAllData()" class="text-xs text-red-500 underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="grid grid-cols-2 gap-3 mb-4">
        <!-- Stock -->
        <div class="bg-white border-2 border-dashed border-indigo-300 rounded-xl p-3 text-center hover:bg-indigo-50">
            <div class="text-2xl mb-1">üì¶</div>
            <p class="font-bold text-indigo-700 text-xs mb-2">1. ‡πÉ‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
            <div class="flex gap-2 justify-center">
                <button onclick="document.getElementById('stock_cam').click()" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-200 flex items-center gap-1 border border-indigo-200">
                    üì∑ ‡∏ñ‡πà‡∏≤‡∏¢
                </button>
                <button onclick="document.getElementById('stock_file').click()" class="bg-white text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-50 flex items-center gap-1 border border-indigo-200">
                    üìÅ ‡πÑ‡∏ü‡∏•‡πå
                </button>
            </div>
            <input type="file" id="stock_cam" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this, 'stock')">
            <input type="file" id="stock_file" accept="image/*" class="hidden" onchange="previewFile(this, 'stock')">
            <div id="previewContainerStock" class="img-preview-box">
                <button class="close-btn" onclick="closeImage(event, 'stock')">√ó</button>
                <img id="imgStock" src="">
            </div>
        </div>

        <!-- Sales -->
        <div class="bg-white border-2 border-dashed border-green-300 rounded-xl p-3 text-center hover:bg-green-50">
            <div class="text-2xl mb-1">üí∞</div>
            <p class="font-bold text-green-700 text-xs mb-2">2. ‡πÉ‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</p>
            <div class="flex gap-2 justify-center">
                <button onclick="document.getElementById('sales_cam').click()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200 flex items-center gap-1 border border-green-200">
                    üì∑ ‡∏ñ‡πà‡∏≤‡∏¢
                </button>
                <button onclick="document.getElementById('sales_file').click()" class="bg-white text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-50 flex items-center gap-1 border border-green-200">
                    üìÅ ‡πÑ‡∏ü‡∏•‡πå
                </button>
            </div>
            <input type="file" id="sales_cam" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this, 'sales')">
            <input type="file" id="sales_file" accept="image/*" class="hidden" onchange="previewFile(this, 'sales')">
            <div id="previewContainerSales" class="img-preview-box">
                <button class="close-btn" onclick="closeImage(event, 'sales')">√ó</button>
                <img id="imgSales" src="">
            </div>
        </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° AI -->
    <div id="aiSection" class="mb-4">
        <button id="btnAutoFill" onclick="extractDataFromImage()" class="w-full bg-yellow-500 text-white font-bold py-2 rounded-lg text-sm shadow-md hover:bg-yellow-600 transition flex items-center justify-center gap-2">
            ‚ú® ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        </button>
        <div id="fillLoading" class="hidden text-center py-2">
            <div class="loading-spinner"></div>
            <p class="text-yellow-700 text-xs mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠...</p>
        </div>
        <div id="apiKeyWarning" class="hidden text-center text-red-500 text-xs mt-1 bg-red-50 p-1 rounded">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI</div>
    </div>

    <!-- 1. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å -->
    <div class="card border-t-4 border-indigo-500">
        <div class="section-header text-indigo-700">üì¶ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
        <div class="stock-grid text-[10px] text-gray-500 font-bold text-center bg-gray-50 p-1 rounded-t">
            <div class="text-left pl-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div> <div>‡πÄ‡∏Å‡πà‡∏≤</div> <div class="text-blue-600">‡πÄ‡∏ï‡∏¥‡∏°</div> <div class="text-red-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
        </div>
        <div class="space-y-2" id="stockContainer"></div>
    </div>

    <!-- 2. ‡πÄ‡∏á‡∏¥‡∏ô -->
    <div class="card border-t-4 border-green-500">
        <div class="section-header text-green-700">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö & ‡∏à‡πà‡∏≤‡∏¢</div>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div><label class="input-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label><input type="number" id="cash" class="input-field bg-green-50" placeholder="0"></div>
            <div><label class="input-label">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô (K)</label><input type="number" id="transfer" class="input-field bg-blue-50" placeholder="0"></div>
        </div>
        <div class="mb-2"><label class="input-label text-red-600">üí∏ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å)</label><input type="number" id="daily_expense" class="input-field bg-red-50" placeholder="65"></div>
        <select id="fixed_cost_select" onchange="toggleCustomFixedCost()" class="w-full text-sm border p-1 rounded bg-gray-50">
            <option value="815">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà+‡πÅ‡∏£‡∏á (815 ‡∏ö.)</option>
            <option value="custom">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á...</option>
        </select>
        <input type="number" id="fixed_cost_custom" class="input-field hidden mt-1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏">
    </div>

    <!-- 3. ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢/‡∏ó‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á -->
    <div class="card border-t-4 border-yellow-400">
        <div class="section-header text-yellow-700">‚ö†Ô∏è ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ & Top</div>
        <div class="grid grid-cols-3 gap-3">
            <div><label class="input-label text-xs">‡πÄ‡∏™‡∏µ‡∏¢:‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß</label><input type="number" id="waste_dumpling" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">‡πÄ‡∏™‡∏µ‡∏¢:BBQ</label><input type="number" id="waste_bbq" class="input-field" placeholder="0"></div>
            
            <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å -->
            <div><label class="input-label text-xs text-blue-600">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å (‡∏ï‡∏±‡∏ß‡∏•‡∏∞10)</label><input type="number" id="individual_10_count" class="input-field bg-blue-50" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß"></div>
            
            <div><label class="input-label text-xs">Set 150 (10‡∏ï‡∏±‡∏ß)</label><input type="number" id="set150_count" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">Set 250 (20‡∏ï‡∏±‡∏ß)</label><input type="number" id="set250_count" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">Set 290 (20‡∏ï‡∏±‡∏ß)</label><input type="number" id="set290_count" class="input-field" placeholder="0"></div>
        </div>
    </div>

    <button onclick="calculateProfit()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:scale-[1.02] transition mb-8">
        ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£
    </button>

    <!-- Settings: API Key -->
    <div class="card border-t-4 border-gray-400 bg-gray-50 mb-8">
        <div class="section-header text-gray-700 flex justify-between" onclick="toggleSettings()">
            <span>üîë ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI)</span>
            <span class="text-xs text-blue-500 underline cursor-pointer">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</span>
        </div>
        <div id="settingsArea" class="hidden">
            <p class="text-xs text-gray-500 mb-2">‡πÉ‡∏™‡πà Gemini API Key ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏Ç‡∏≠‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà aistudio.google.com)</p>
            <input type="password" id="apiKeyInput" class="w-full border p-2 rounded mb-2 text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ AIza... ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            <button onclick="saveApiKey()" class="w-full bg-gray-600 text-white py-1 rounded text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏∏‡∏ç‡πÅ‡∏à</button>
            <p id="keyStatus" class="text-xs text-center mt-2 text-gray-400"></p>
        </div>
    </div>

    <!-- Modal ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
    <div id="resultSection" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[85vh] overflow-y-auto">
            <div class="bg-gray-800 p-3 text-white flex justify-between items-center sticky top-0">
                <h2 class="font-bold">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</h2>
                <button onclick="closeResult()" class="text-white text-xl">&times;</button>
            </div>
            <div class="p-4 space-y-3 text-sm">
                <!-- Audit -->
                <div id="audit_box" class="p-3 rounded-lg border-2">
                    <h3 class="font-bold flex gap-2"><span id="audit_icon"></span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    
                    <div class="flex justify-between mt-1 items-end">
                        <span class="text-gray-600 text-xs">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á (Stock Value):</span> 
                        <span id="res_expected" class="font-bold text-base">0</span>
                    </div>
                    
                    <div class="flex justify-between border-b pb-1 items-end">
                        <span class="text-gray-600 text-xs">‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (‡∏´‡∏±‡∏ÅTop/‡∏ö‡∏ß‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î):</span> 
                        <span id="res_actual" class="text-blue-600 font-bold text-base">0</span>
                    </div>
                    
                    <div class="flex justify-between mt-2 items-center bg-gray-50 p-2 rounded">
                        <span class="font-bold text-gray-800">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á:</span> 
                        <span id="res_diff" class="text-xl font-bold">0</span>
                    </div>
                    
                    <div class="text-[10px] text-gray-400 text-center mt-1">
                        (‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á = <span id="res_raw_cash">0</span> | ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á = <span id="res_adj_val">0</span>)
                    </div>
                    <p id="audit_msg" class="text-sm font-bold text-center mt-2"></p>
                </div>
                
                <!-- Profit -->
                <div class="text-center bg-green-50 p-3 rounded-lg border border-green-200">
                    <p class="text-green-800 font-bold">üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <div id="res_profit" class="text-3xl font-bold text-green-600">0</div>
                </div>

                <!-- Breakdown Sales -->
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <p class="font-bold text-gray-700 mb-2 border-b pb-1">üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Sold):</p>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-center py-2 bg-yellow-50 rounded border border-yellow-100">
                            <span class="text-xs text-yellow-800 block">ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏Ç‡∏≤‡∏¢</span>
                            <span id="res_total_dumplings" class="text-lg font-bold text-yellow-700">0</span>
                            <span class="text-xs text-yellow-600">‡∏ï‡∏±‡∏ß</span>
                        </div>
                        <div class="text-center py-2 bg-red-50 rounded border border-red-100">
                            <span class="text-xs text-red-800 block">üç¢ BBQ ‡∏Ç‡∏≤‡∏¢</span>
                            <span id="res_total_bbq" class="text-lg font-bold text-red-700">0</span>
                            <span class="text-xs text-red-600">‡πÑ‡∏°‡πâ</span>
                        </div>
                    </div>
                    <div id="item_breakdown_list" class="space-y-1 text-xs text-gray-600"></div>
                </div>

                 <!-- Remaining Stock -->
                 <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 mt-2">
                    <p class="font-bold text-blue-800 mb-2 border-b border-blue-200 pb-1">üßä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Stock ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠):</p>
                    <div id="remaining_stock_list" class="space-y-1 text-xs text-blue-700"></div>
                </div>

                <!-- Export & AI Analysis -->
                <div class="mt-2 pt-2 border-t space-y-2">
                    <button onclick="exportReport()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        üì§ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (TXT)
                    </button>
                    <button id="btnAskAI" onclick="askGemini()" class="w-full bg-purple-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• (AI)
                    </button>
                    <div id="aiLoading" class="hidden text-center mt-2"><div class="loading-spinner"></div></div>
                    <div id="aiResult" class="hidden mt-2 text-xs bg-purple-50 p-2 rounded markdown-body"></div>
                </div>
            </div>
            <div class="p-2 bg-gray-100 text-center"><button onclick="closeResult()" class="w-full bg-gray-300 py-2 rounded text-gray-700 font-bold">‡∏õ‡∏¥‡∏î</button></div>
        </div>
    </div>

    <script>
        // Init Stock UI
        const products = [
            {id:'s', name:'‡∏Å‡∏∏‡πâ‡∏á(S)', desc:'‡∏ñ‡∏∏‡∏á24', color:'text-orange-600', unit:24},
            {id:'c', name:'‡πÑ‡∏Å‡πà(C)', desc:'‡∏ñ‡∏∏‡∏á32', color:'text-yellow-600', unit:32},
            {id:'p', name:'‡∏´‡∏°‡∏π(P)', desc:'‡∏ñ‡∏∏‡∏á32', color:'text-pink-600', unit:32},
            {id:'v', name:'‡∏ú‡∏±‡∏Å(V)', desc:'‡∏ñ‡∏∏‡∏á30', color:'text-green-600', unit:30},
            {id:'bb', name:'BBQ', desc:'‡∏ñ‡∏∏‡∏á20', color:'text-red-700', unit:20},
            {id:'b', name:'‡∏û‡∏£‡∏¥‡∏Å(B)', desc:'‡∏ñ‡∏∏‡∏á20', color:'text-gray-600', unit:20}
        ];
        const stockHTML = products.map(p => `
            <div class="stock-grid">
                <div class="text-xs font-bold ${p.color}">${p.name}<br><span class="text-[9px] text-gray-400 font-normal">${p.desc}</span></div>
                <div class="dual-input"><input type="number" id="${p.id}_prev_bag" placeholder="‡∏ñ" class="input-field bg-gray-50" onchange="autoSave()"><input type="number" id="${p.id}_prev_unit" placeholder="‡∏®" class="input-field bg-gray-50" onchange="autoSave()"></div>
                <div class="dual-input"><input type="number" id="${p.id}_add_bag" placeholder="‡∏ñ" class="input-field bg-blue-50" onchange="autoSave()"><input type="number" id="${p.id}_add_unit" placeholder="‡∏®" class="input-field bg-blue-50" onchange="autoSave()"></div>
                <div class="dual-input"><input type="number" id="${p.id}_end_bag" placeholder="‡∏ñ" class="input-field bg-red-50" onchange="autoSave()"><input type="number" id="${p.id}_end_unit" placeholder="‡∏®" class="input-field bg-red-50" onchange="autoSave()"></div>
            </div>
        `).join('');
        document.getElementById('stockContainer').innerHTML = stockHTML;

        // Auto Save Inputs
        const allInputs = ['cash', 'transfer', 'daily_expense', 'waste_dumpling', 'waste_bbq', 'individual_10_count', 'set150_count', 'set250_count', 'set290_count', 'fixed_cost_custom'];
        allInputs.forEach(id => {
            document.getElementById(id).addEventListener('change', autoSave);
        });

        function autoSave() {
            const data = {};
            // Save Stock Inputs
            products.forEach(p => {
                ['prev', 'add', 'end'].forEach(type => {
                    data[`${p.id}_${type}_bag`] = document.getElementById(`${p.id}_${type}_bag`).value;
                    data[`${p.id}_${type}_unit`] = document.getElementById(`${p.id}_${type}_unit`).value;
                });
            });
            // Save Sales Inputs
            allInputs.forEach(id => {
                data[id] = document.getElementById(id).value;
            });
            data['fixed_cost_select'] = document.getElementById('fixed_cost_select').value;
            
            localStorage.setItem('shop_v16_data', JSON.stringify(data));
            document.getElementById('saveStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß " + new Date().toLocaleTimeString();
        }

        function loadAutoSave() {
            const saved = localStorage.getItem('shop_v16_data');
            if(saved) {
                const data = JSON.parse(saved);
                products.forEach(p => {
                    ['prev', 'add', 'end'].forEach(type => {
                        setVal(`${p.id}_${type}_bag`, data[`${p.id}_${type}_bag`]);
                        setVal(`${p.id}_${type}_unit`, data[`${p.id}_${type}_unit`]);
                    });
                });
                allInputs.forEach(id => {
                    setVal(id, data[id]);
                });
                if(data['fixed_cost_select']) {
                    document.getElementById('fixed_cost_select').value = data['fixed_cost_select'];
                    toggleCustomFixedCost();
                }
            }
        }

        function clearAllData() {
            if(confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                localStorage.removeItem('shop_v16_data');
                location.reload();
            }
        }

        // --- Logic ---
        function getApiKey() { return localStorage.getItem('gemini_api_key'); }
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('keyStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
                document.getElementById('apiKeyWarning').classList.add('hidden');
            }
        }
        function toggleSettings() { document.getElementById('settingsArea').classList.toggle('hidden'); }
        
        if(getApiKey()) { 
            document.getElementById('apiKeyInput').value = getApiKey();
            document.getElementById('keyStatus').innerText = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
        }

        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        function updateStatus() {
            const el = document.getElementById('connectionStatus');
            if(navigator.onLine) {
                el.className = 'status-online'; el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
            } else {
                el.className = 'status-offline'; el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-600"></span> ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
            }
        }

        window.stockData = { base64: null, mime: null };
        window.salesData = { base64: null, mime: null };

        function previewFile(input, type) {
            const imgBox = document.getElementById(type === 'stock' ? 'previewContainerStock' : 'previewContainerSales');
            const img = document.getElementById(type === 'stock' ? 'imgStock' : 'imgSales');
            const file = input.files[0];
            
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function() {
                img.src = reader.result; 
                imgBox.style.display = 'block';
                
                try {
                    const base64 = reader.result.split(',')[1];
                    const mime = reader.result.split(',')[0].match(/:(.*?);/)[1];

                    if(type === 'stock') {
                         window.stockData = { base64, mime };
                    } else {
                         window.salesData = { base64, mime };
                    }
                } catch (e) {
                    console.error("Error reading file:", e);
                    alert("‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà");
                }
            }
            reader.readAsDataURL(file);
        }

        function closeImage(e, type) {
            e.stopPropagation();
            document.getElementById(type === 'stock' ? 'previewContainerStock' : 'previewContainerSales').style.display = 'none';
            if (type === 'stock') {
                document.getElementById('stock_cam').value = "";
                document.getElementById('stock_file').value = "";
                window.stockData = { base64: null, mime: null };
            } else {
                document.getElementById('sales_cam').value = "";
                document.getElementById('sales_file').value = "";
                window.salesData = { base64: null, mime: null };
            }
        }

        function closeResult() {
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('aiResult').classList.add('hidden');
            document.getElementById('btnAskAI').classList.remove('hidden');
        }
        function toggleCustomFixedCost() {
            const val = document.getElementById('fixed_cost_select').value;
            document.getElementById('fixed_cost_custom').classList.toggle('hidden', val !== 'custom');
            autoSave();
        }
        function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
        function setVal(id, val) { if(val !== null && val !== undefined) document.getElementById(id).value = val; }

        let globalData = {};

        function calculateStock(pfx, unitPerBag) {
            let prev = (getVal(pfx+'_prev_bag') * unitPerBag) + getVal(pfx+'_prev_unit');
            let add = (getVal(pfx+'_add_bag') * unitPerBag) + getVal(pfx+'_add_unit');
            let end = (getVal(pfx+'_end_bag') * unitPerBag) + getVal(pfx+'_end_unit');
            return Math.max(0, (prev + add) - end);
        }

        function calculateProfit() {
            let cash = getVal('cash'), transfer = getVal('transfer'), daily = getVal('daily_expense');
            let actual_rev = cash + transfer + daily;

            let s = calculateStock('s', 24), c = calculateStock('c', 32), p = calculateStock('p', 32), v = calculateStock('v', 30);
            let bb = calculateStock('bb', 20), b = calculateStock('b', 20);

            let dump_waste = getVal('waste_dumpling'), bbq_waste = getVal('waste_bbq');
            let set150 = getVal('set150_count'), set290 = getVal('set290_count'), set250 = getVal('set250_count');
            let individual10 = getVal('individual_10_count');

            let dump_sales_val = (s+c+p+v - dump_waste) * 13;
            let bbq_sales_val = (bb+b - bbq_waste) * 50;
            
            // Expected Revenue is PURE Stock Value (No adjustments here)
            let expected = dump_sales_val + bbq_sales_val;

            // Logic V16.1: Adjust Cash instead of Expected Revenue
            // Surcharge 150 (+20): Means Cash is higher than stock value. Subtract to match stock.
            // Surcharge 290 (+30): Means Cash is higher. Subtract.
            // Discount 250 (-10): Means Cash is lower than stock. Add back to match stock.
            // Individual (-3): Means Cash is lower. Add back to match stock.
            
            let surcharge = (set150 * 20) + (set290 * 30);
            let discount = (set250 * 10) + (individual10 * 3);
            
            let adjusted_actual = actual_rev - surcharge + discount;

            let cost = ((s+c+p+v) * 6.5) + ((bb+b) * 24);
            let fixed = document.getElementById('fixed_cost_select').value === 'custom' ? getVal('fixed_cost_custom') : parseFloat(document.getElementById('fixed_cost_select').value);
            let profit = actual_rev - cost - fixed - daily;
            
            let totalDumplingsSold = s + c + p + v;
            let totalBBQSold = bb + b;

            let remainingText = "";
            let remainingItems = [];
            products.forEach(prod => {
                let endBag = getVal(`${prod.id}_end_bag`);
                let endUnit = getVal(`${prod.id}_end_unit`);
                let totalRemainingUnits = (endBag * prod.unit) + endUnit;
                let displayBag = Math.floor(totalRemainingUnits / prod.unit);
                let displayUnit = totalRemainingUnits % prod.unit;
                let unitName = (prod.id === 'bb' || prod.id === 'b') ? '‡πÑ‡∏°‡πâ' : '‡∏ï‡∏±‡∏ß';
                
                if (totalRemainingUnits > 0) {
                    let txt = `<b>${prod.name}:</b> ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${displayBag} ‡∏ñ‡∏∏‡∏á ‡∏Å‡∏±‡∏ö ${displayUnit} ${unitName}`;
                    remainingText += `<div class="flex justify-between">${txt}</div>`;
                    remainingItems.push(`${prod.name}: ${displayBag} ‡∏ñ ${displayUnit} ${unitName}`);
                } else {
                     remainingText += `<div class="flex justify-between text-gray-400">${prod.name}: ‡∏´‡∏°‡∏î</div>`;
                     remainingItems.push(`${prod.name}: ‡∏´‡∏°‡∏î`);
                }
            });

            globalData = { 
                actual_rev, profit, 
                diff: adjusted_actual - expected, 
                items: {s,c,p,v,bb,b, dumplings: totalDumplingsSold, bbq: totalBBQSold, individual: individual10},
                remaining: remainingItems,
                adj_val: (discount - surcharge) // Net adjustment for display
            };
            
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('res_expected').innerText = expected.toLocaleString();
            document.getElementById('res_actual').innerText = adjusted_actual.toLocaleString(); // Show Adjusted Cash
            document.getElementById('res_diff').innerText = (adjusted_actual - expected).toLocaleString();
            document.getElementById('res_profit').innerText = profit.toLocaleString() + " ‡∏ø";
            
            document.getElementById('res_raw_cash').innerText = actual_rev.toLocaleString();
            document.getElementById('res_adj_val').innerText = (globalData.adj_val >= 0 ? "+" : "") + globalData.adj_val.toLocaleString();
            
            document.getElementById('res_total_dumplings').innerText = totalDumplingsSold.toLocaleString();
            document.getElementById('res_total_bbq').innerText = totalBBQSold.toLocaleString();
            document.getElementById('remaining_stock_list').innerHTML = remainingText;

            let diff = adjusted_actual - expected;
            let box = document.getElementById('audit_box');
            if(Math.abs(diff) < 50) { 
                box.className = "p-3 rounded-lg border-2 audit-pass"; 
                document.getElementById('audit_msg').innerText = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á (Perfect)";
                document.getElementById('res_diff').className = "text-xl font-bold text-green-700";
            }
            else if(diff > 0) { 
                box.className = "p-3 rounded-lg border-2 bg-blue-50 border-blue-200 text-blue-700"; 
                document.getElementById('audit_msg').innerText = "‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô (Surplus)";
                document.getElementById('res_diff').className = "text-xl font-bold text-blue-700";
            }
            else { 
                box.className = "p-3 rounded-lg border-2 audit-fail"; 
                document.getElementById('audit_msg').innerText = "‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢ (Missing)"; 
                document.getElementById('res_diff').className = "text-xl font-bold text-red-700";
            }

            document.getElementById('item_breakdown_list').innerHTML = `
                <div class="flex justify-between"><span>ü¶ê ‡∏Å‡∏∏‡πâ‡∏á (S):</span> <span>${s} ‡∏ï‡∏±‡∏ß</span></div>
                <div class="flex justify-between"><span>üêî ‡πÑ‡∏Å‡πà (C):</span> <span>${c} ‡∏ï‡∏±‡∏ß</span></div>
                <div class="flex justify-between"><span>üê∑ ‡∏´‡∏°‡∏π (P):</span> <span>${p} ‡∏ï‡∏±‡∏ß</span></div>
                <div class="flex justify-between"><span>ü•¨ ‡∏ú‡∏±‡∏Å (V):</span> <span>${v} ‡∏ï‡∏±‡∏ß</span></div>
                <div class="flex justify-between text-blue-600 text-xs mt-1"><span>* ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å (‡∏ï‡∏±‡∏ß‡∏•‡∏∞ 10):</span> <span>${individual10} ‡∏ï‡∏±‡∏ß</span></div>
                <div class="flex justify-between border-t border-dashed my-1 pt-1"><span>üç¢ ‡∏ö‡∏≤‡∏£‡πå‡∏ö‡∏µ‡∏Ñ‡∏¥‡∏ß (BB):</span> <span>${bb} ‡πÑ‡∏°‡πâ</span></div>
                <div class="flex justify-between"><span>üå∂Ô∏è ‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢‡∏î‡∏≥ (B):</span> <span>${b} ‡πÑ‡∏°‡πâ</span></div>
            `;
        }

        function exportReport() {
            if (!globalData.items) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            const d = new Date();
            const dateStr = d.toLocaleDateString('th-TH');
            const timeStr = d.toLocaleTimeString('th-TH');
            
            let txt = `=== ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô (${dateStr} ${timeStr}) ===\n`;
            txt += `‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á: ${globalData.actual_rev.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${globalData.profit.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${document.getElementById('audit_msg').innerText} (${document.getElementById('res_diff').innerText})\n`;
            txt += `(‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ${document.getElementById('res_adj_val').innerText})\n`;
            txt += `--------------------------\n`;
            txt += `[‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢]\n`;
            txt += `ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏Ç‡∏≤‡∏¢: ${globalData.items.dumplings} ‡∏ï‡∏±‡∏ß\n`;
            txt += `   (‡∏£‡∏ß‡∏°‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å: ${globalData.items.individual} ‡∏ï‡∏±‡∏ß)\n`;
            txt += `üç¢ BBQ ‡∏Ç‡∏≤‡∏¢: ${globalData.items.bbq} ‡πÑ‡∏°‡πâ\n`;
            txt += `--------------------------\n`;
            txt += `[‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠]\n`;
            globalData.remaining.forEach(line => { txt += `- ${line}\n`; });
            txt += `==========================\n`;
            txt += `Created by Smart Shop V16.1`;

            const blob = new Blob(["\uFEFF" + txt], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `report_${d.toISOString().slice(0,10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function extractDataFromImage() {
            if (!navigator.onLine) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ñ‡∏£‡∏±‡∏ö");
            const apiKey = getApiKey();
            if (!apiKey) {
                document.getElementById('apiKeyWarning').classList.remove('hidden');
                document.getElementById('settingsArea').classList.remove('hidden'); 
                document.getElementById('apiKeyInput').focus();
                return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            }
            if (!window.stockData.base64 && !window.salesData.base64) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            
            document.getElementById('btnAutoFill').classList.add('hidden');
            document.getElementById('fillLoading').classList.remove('hidden');
            
            const contentParts = [{ text: `
                Extract shop data to JSON from these handwritten logs.
                Stock Log (Table with S, C, P...): Look for previous (start) and added (refill) amounts.
                Sales Log: Look for Ending counts, Cash, Transfer (K), Expenses.
                JSON Keys: cash, transfer, daily_expense, set150_count, set290_count, set250_count, individual_10_count,
                s_prev_bag, s_prev_unit, s_add_bag, s_add_unit, s_end_bag, s_end_unit,
                c_prev_bag, c_prev_unit, c_add_bag, c_add_unit, c_end_bag, c_end_unit,
                p_prev_bag, p_prev_unit, p_add_bag, p_add_unit, p_end_bag, p_end_unit,
                v_prev_bag, v_prev_unit, v_add_bag, v_add_unit, v_end_bag, v_end_unit,
                bb_prev_bag, bb_prev_unit, bb_add_bag, bb_add_unit, bb_end_bag, bb_end_unit,
                b_prev_bag, b_prev_unit, b_add_bag, b_add_unit, b_end_bag, b_end_unit.
                Use 0 for missing values.
                Output ONLY valid JSON. No markdown.
            ` }];
            
            if (window.stockData.base64) contentParts.push({ inlineData: { mimeType: window.stockData.mime, data: window.stockData.base64 } });
            if (window.salesData.base64) contentParts.push({ inlineData: { mimeType: window.salesData.mime, data: window.salesData.base64 } });

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ role: "user", parts: contentParts }] })
                });
                const data = await res.json();
                
                if(data.error) {
                     if (data.error.message.includes("API key not valid") || data.error.code === 400 || data.error.code === 403) {
                         throw new Error("API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏£‡∏±‡∏ö (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)");
                     }
                     throw new Error(data.error.message);
                }
                
                let txt = data.candidates[0].content.parts[0].text;
                const jsonMatch = txt.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    txt = jsonMatch[0];
                } else {
                    throw new Error("AI ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ JSON ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ (Invalid Format)");
                }
                
                const j = JSON.parse(txt);

                ['cash','transfer','daily_expense', 'set150_count', 'set290_count', 'set250_count', 'individual_10_count'].forEach(k => setVal(k, j[k]));
                ['s','c','p','v','bb','b'].forEach(i => {
                    ['prev','add','end'].forEach(t => {
                        setVal(`${i}_${t}_bag`, j[`${i}_${t}_bag`]);
                        setVal(`${i}_${t}_unit`, j[`${i}_${t}_unit`]);
                    });
                });
                alert("AI ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö");
                autoSave();
            } catch(e) { 
                console.error(e);
                let msg = e.message;
                if (msg.includes("API Key") || msg.includes("not valid") || msg.includes("403")) {
                    msg = "API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤";
                    document.getElementById('settingsArea').classList.remove('hidden');
                    document.getElementById('apiKeyInput').focus();
                }
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + msg); 
            }
            
            document.getElementById('fillLoading').classList.add('hidden');
            document.getElementById('btnAutoFill').classList.remove('hidden');
        }

        async function askGemini() {
            if (!navigator.onLine) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ñ‡∏£‡∏±‡∏ö");
            const apiKey = getApiKey();
            if (!apiKey) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            document.getElementById('btnAskAI').classList.add('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤: ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ${globalData.actual_rev}, ‡∏Å‡∏≥‡πÑ‡∏£ ${globalData.profit}, ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ${globalData.items.dumplings} ‡∏ï‡∏±‡∏ß, BBQ ${globalData.items.bbq} ‡πÑ‡∏°‡πâ), ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${JSON.stringify(globalData.remaining)}. ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡∏ô‡∏∏‡∏Å‡πÜ`;
             try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                
                if(data.error) {
                     if (data.error.message.includes("API key not valid")) {
                         document.getElementById('settingsArea').classList.remove('hidden');
                         throw new Error("API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
                     }
                     throw new Error(data.error.message);
                }

                const txt = data.candidates[0].content.parts[0].text;
                document.getElementById('aiResult').innerHTML = marked.parse(txt);
                document.getElementById('aiResult').classList.remove('hidden');
            } catch(e) { 
                console.log(e); 
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î AI: " + e.message); 
            }
            document.getElementById('aiLoading').classList.add('hidden');
        }

        // Load data on startup
        loadAutoSave();
    </script>
</body>
</html>
