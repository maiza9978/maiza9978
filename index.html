<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô V19.2 (Connected)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f9ff; padding-bottom: 120px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.2rem; text-align: center; }
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.4rem; font-size: 1rem; text-align: center; font-weight: 500; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px solid #bfdbfe; }
        .section-header { font-size: 1.1rem; font-weight: bold; color: #0f172a; margin-bottom: 0.8rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; }
        
        .stock-grid { display: grid; grid-template-columns: 1fr 1.5fr 1.5fr 1.5fr; gap: 4px; align-items: end; margin-bottom: 8px; }
        .dual-input { display: flex; gap: 2px; }
        .dual-input input { width: 50%; font-size: 0.9rem; }
        
        .wh-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .img-preview-box { display: none; margin-top: 5px; text-align: center; background: #e2e8f0; border-radius: 8px; padding: 4px; position: relative; }
        .img-preview-box img { max-height: 120px; max-width: 100%; border-radius: 4px; border: 2px solid white; display: inline-block; }
        .close-btn { background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; position: absolute; top: -5px; right: -5px; cursor: pointer; line-height: 20px; font-size: 12px; }

        .audit-pass { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .audit-fail { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        #connectionStatus { font-size: 0.8rem; padding: 4px 12px; border-radius: 20px; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; }
        .status-online { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-offline { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        @media print {
            body { background-color: white; padding: 0; }
            .no-print, .card, #connectionStatus, #saveStatus, button { display: none !important; }
            #resultSection { position: static; display: block !important; background: white; width: 100%; max-width: 100%; box-shadow: none; overflow: visible; }
            #resultSection > div { width: 100%; max-width: 100%; box-shadow: none; border: none; }
            #resultSection .bg-gray-800 { background: white !important; color: black !important; border-bottom: 2px solid black; }
            #resultSection .text-white { color: black !important; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; }
            .markdown-body { display: none; }
        }
    </style>
</head>
<body class="p-3 max-w-xl mx-auto">

    <div class="flex justify-between items-center mb-4 no-print">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">ü•ü ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô V19.2</h1>
            <p id="saveStatus" class="text-xs text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>
        <div class="flex flex-col items-end gap-1">
            <div id="connectionStatus" class="status-online">
                <span class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            </div>
            <button onclick="openHistory()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-200 hover:bg-indigo-100 flex items-center gap-1">
                üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
            </button>
        </div>
    </div>

    <!-- Shop Info -->
    <div class="card border-t-4 border-slate-600 no-print">
        <div class="section-header text-slate-700">üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</div>
        <div class="grid grid-cols-2 gap-3">
            <div><label class="input-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="text" id="shop_name" class="input-field bg-slate-50" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß"></div>
            <div><label class="input-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" id="staff_name" class="input-field bg-slate-50" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"></div>
        </div>
        <div class="mt-2"><label class="input-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="record_date" class="input-field bg-slate-50"></div>
    </div>

    <!-- Upload Section -->
    <div class="grid grid-cols-2 gap-3 mb-4 no-print">
        <div class="bg-white border-2 border-dashed border-indigo-300 rounded-xl p-3 text-center hover:bg-indigo-50">
            <div class="text-2xl mb-1">üì¶</div>
            <p class="font-bold text-indigo-700 text-xs mb-2">1. ‡πÉ‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
            <div class="flex gap-2 justify-center">
                <button onclick="document.getElementById('stock_cam').click()" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-200 flex items-center gap-1 border border-indigo-200">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢</button>
                <button onclick="document.getElementById('stock_file').click()" class="bg-white text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-50 flex items-center gap-1 border border-indigo-200">üìÅ ‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            <input type="file" id="stock_cam" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this, 'stock')">
            <input type="file" id="stock_file" accept="image/*" class="hidden" onchange="previewFile(this, 'stock')">
            <div id="previewContainerStock" class="img-preview-box">
                <button class="close-btn" onclick="closeImage(event, 'stock')">√ó</button>
                <img id="imgStock" src="">
            </div>
        </div>
        <div class="bg-white border-2 border-dashed border-green-300 rounded-xl p-3 text-center hover:bg-green-50">
            <div class="text-2xl mb-1">üí∞</div>
            <p class="font-bold text-green-700 text-xs mb-2">2. ‡πÉ‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</p>
            <div class="flex gap-2 justify-center">
                <button onclick="document.getElementById('sales_cam').click()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200 flex items-center gap-1 border border-green-200">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢</button>
                <button onclick="document.getElementById('sales_file').click()" class="bg-white text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-50 flex items-center gap-1 border border-green-200">üìÅ ‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            <input type="file" id="sales_cam" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this, 'sales')">
            <input type="file" id="sales_file" accept="image/*" class="hidden" onchange="previewFile(this, 'sales')">
            <div id="previewContainerSales" class="img-preview-box">
                <button class="close-btn" onclick="closeImage(event, 'sales')">√ó</button>
                <img id="imgSales" src="">
            </div>
        </div>
    </div>

    <!-- AI Button -->
    <div id="aiSection" class="mb-4 no-print">
        <button id="btnAutoFill" onclick="extractDataFromImage()" class="w-full bg-yellow-500 text-white font-bold py-2 rounded-lg text-sm shadow-md hover:bg-yellow-600 transition flex items-center justify-center gap-2">
            ‚ú® ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        </button>
        <div id="fillLoading" class="hidden text-center py-2">
            <div class="loading-spinner"></div>
            <p class="text-yellow-700 text-xs mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠...</p>
        </div>
        <div id="apiKeyWarning" class="hidden text-center text-red-500 text-xs mt-1 bg-red-50 p-1 rounded">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI</div>
    </div>

    <!-- 1. Stock Check Table -->
    <div class="card border-t-4 border-indigo-500 no-print">
        <div class="section-header text-indigo-700">üì¶ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</div>
        <div class="stock-grid text-[10px] text-gray-500 font-bold text-center bg-gray-50 p-1 rounded-t">
            <div class="text-left pl-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div> <div>‡πÄ‡∏Å‡πà‡∏≤</div> <div class="text-blue-600">‡πÄ‡∏ï‡∏¥‡∏°</div> <div class="text-red-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
        </div>
        <div class="space-y-2" id="stockContainer"></div>
    </div>

    <!-- 2. Warehouse Stock -->
    <div class="card border-t-4 border-purple-500 no-print">
        <div class="section-header text-purple-700 flex justify-between items-center">
            <span>üè≠ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏´‡∏±‡∏Å‡∏•‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</span>
            <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full" id="wh_total_value">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: 0 ‡∏ø</span>
        </div>
        <div class="text-[10px] text-gray-500 mb-2">* ‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î "‡πÄ‡∏ï‡∏¥‡∏°" ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á</div>
        <div class="wh-grid font-bold text-[10px] text-gray-500 text-center bg-gray-50 p-1 rounded-t">
            <div class="text-left pl-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div> <div>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡∏ñ‡∏∏‡∏á)</div> <div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ñ‡∏∏‡∏á</div>
        </div>
        <div class="space-y-3" id="warehouseContainer"></div>
    </div>

    <!-- 3. Money Table -->
    <div class="card border-t-4 border-green-500 no-print">
        <div class="section-header text-green-700">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö & ‡∏à‡πà‡∏≤‡∏¢</div>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div><label class="input-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label><input type="number" id="cash" class="input-field bg-green-50" placeholder="0"></div>
            <div><label class="input-label">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô (K)</label><input type="number" id="transfer" class="input-field bg-blue-50" placeholder="0"></div>
        </div>
        <div class="mb-2"><label class="input-label text-red-600">üí∏ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å)</label><input type="number" id="daily_expense" class="input-field bg-red-50" placeholder="65"></div>
        <select id="fixed_cost_select" onchange="toggleCustomFixedCost()" class="w-full text-sm border p-1 rounded bg-gray-50">
            <option value="815">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà+‡πÅ‡∏£‡∏á (815 ‡∏ö.)</option>
            <option value="custom">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á...</option>
        </select>
        <input type="number" id="fixed_cost_custom" class="input-field hidden mt-1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏">
    </div>

    <!-- 4. Waste & Topping -->
    <div class="card border-t-4 border-yellow-400 no-print">
        <div class="section-header text-yellow-700">‚ö†Ô∏è ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ & Top</div>
        <div class="grid grid-cols-3 gap-3">
            <div><label class="input-label text-xs">‡πÄ‡∏™‡∏µ‡∏¢:‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß</label><input type="number" id="waste_dumpling" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">‡πÄ‡∏™‡∏µ‡∏¢:BBQ</label><input type="number" id="waste_bbq" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs text-blue-600">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å (‡∏ï‡∏±‡∏ß‡∏•‡∏∞10)</label><input type="number" id="individual_10_count" class="input-field bg-blue-50" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"></div>
            <div><label class="input-label text-xs">Set 150 (10‡∏ï‡∏±‡∏ß)</label><input type="number" id="set150_count" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">Set 250 (20‡∏ï‡∏±‡∏ß)</label><input type="number" id="set250_count" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">Set 290 (20‡∏ï‡∏±‡∏ß)</label><input type="number" id="set290_count" class="input-field" placeholder="0"></div>
        </div>
    </div>

    <button onclick="calculateProfit()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:scale-[1.02] transition mb-8 no-print">
        ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£ & ‡∏™‡∏ï‡πá‡∏≠‡∏Å
    </button>

    <!-- Settings -->
    <div class="card border-t-4 border-gray-400 bg-gray-50 mb-8 no-print">
        <div class="section-header text-gray-700 flex justify-between" onclick="toggleSettings()">
            <span>üîë ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key & Link</span>
            <span class="text-xs text-blue-500 underline cursor-pointer">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</span>
        </div>
        <div id="settingsArea" class="hidden">
            <p class="text-xs text-gray-500 mb-1">Gemini API Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI)</p>
            <input type="password" id="apiKeyInput" class="w-full border p-2 rounded mb-3 text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ AIza... ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            
            <p class="text-xs text-gray-500 mb-1">Google Script URL (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏µ‡∏ï)</p>
            <input type="text" id="scriptUrlInput" class="w-full border p-2 rounded mb-3 text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå https://script.google.com/.../exec">
            
            <button onclick="saveApiKey()" class="w-full bg-gray-600 text-white py-1 rounded text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            <p id="keyStatus" class="text-xs text-center mt-2 text-gray-400"></p>
            
            <div class="mt-4 pt-4 border-t">
                <button onclick="clearAllData()" class="w-full text-red-500 text-xs border border-red-200 rounded py-1 hover:bg-red-50">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultSection" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[90vh] overflow-y-auto">
            <div class="bg-gray-800 p-3 text-white flex justify-between items-center sticky top-0 no-print">
                <h2 class="font-bold">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</h2>
                <button onclick="closeResult()" class="text-white text-xl">&times;</button>
            </div>
            
            <div id="printHeader" style="display:none;" class="text-center mb-4 pt-4">
                <h1 class="text-xl font-bold">‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h1>
                <p id="print_shop_name" class="text-sm"></p>
                <p id="print_date_staff" class="text-xs text-gray-500"></p>
                <hr class="my-2 border-gray-300">
            </div>

            <div class="p-4 space-y-3 text-sm">
                <!-- Audit -->
                <div id="audit_box" class="p-3 rounded-lg border-2">
                    <h3 class="font-bold flex gap-2 no-print"><span id="audit_icon"></span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="flex justify-between mt-1 items-end">
                        <span class="text-gray-600 text-xs">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á:</span> 
                        <span id="res_expected" class="font-bold text-base">0</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 items-end">
                        <span class="text-gray-600 text-xs">‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á:</span> 
                        <span id="res_actual" class="text-blue-600 font-bold text-base">0</span>
                    </div>
                    <div class="flex justify-between mt-2 items-center bg-gray-50 p-2 rounded">
                        <span class="font-bold text-gray-800">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á:</span> 
                        <span id="res_diff" class="text-xl font-bold">0</span>
                    </div>
                    <p id="audit_msg" class="text-sm font-bold text-center mt-2"></p>
                </div>
                
                <!-- Profit -->
                <div class="text-center bg-green-50 p-3 rounded-lg border border-green-200">
                    <p class="text-green-800 font-bold">üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <div id="res_profit" class="text-3xl font-bold text-green-600">0</div>
                    <div class="w-full bg-red-200 rounded-full h-2.5 mt-3 overflow-hidden flex">
                        <div id="chart_cost_bar" class="bg-red-500 h-2.5" style="width: 50%"></div>
                        <div id="chart_profit_bar" class="bg-green-500 h-2.5" style="width: 50%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                        <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô <span id="chart_cost_pct">50%</span></span>
                        <span>‡∏Å‡∏≥‡πÑ‡∏£ <span id="chart_profit_pct">50%</span></span>
                    </div>
                </div>

                <!-- Warehouse Summary -->
                <div class="bg-purple-50 p-3 rounded-lg border border-purple-200 mt-2">
                    <p class="font-bold text-purple-900 mb-2 border-b border-purple-200 pb-1">üè≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠):</p>
                    <div id="res_wh_list" class="space-y-1 text-xs text-purple-800"></div>
                    <div class="mt-2 text-right font-bold text-purple-900 text-sm">‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="res_wh_value">0</span> ‡∏ø</div>
                </div>

                <!-- Sales -->
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <p class="font-bold text-gray-700 mb-2 border-b pb-1">üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Sold):</p>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-center py-2 bg-yellow-50 rounded border border-yellow-100">
                            <span class="text-xs text-yellow-800 block">ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏Ç‡∏≤‡∏¢</span>
                            <span id="res_total_dumplings" class="text-lg font-bold text-yellow-700">0</span>
                        </div>
                        <div class="text-center py-2 bg-red-50 rounded border border-red-100">
                            <span class="text-xs text-red-800 block">üç¢ BBQ ‡∏Ç‡∏≤‡∏¢</span>
                            <span id="res_total_bbq" class="text-lg font-bold text-red-700">0</span>
                        </div>
                    </div>
                    <div id="item_breakdown_list" class="space-y-1 text-xs text-gray-600"></div>
                </div>

                <!-- Actions -->
                <div class="mt-2 pt-2 border-t space-y-2 no-print">
                    <button onclick="saveToHistory()" id="btnSaveHistory" class="w-full bg-emerald-600 text-white py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-lg animate-pulse">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Local)
                    </button>
                    <!-- Google Sheet Button -->
                    <button onclick="sendToGoogleSheet()" id="btnSendSheet" class="w-full bg-green-600 text-white py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-lg">
                        üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.print()" class="w-full bg-slate-700 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå/PDF
                        </button>
                        <button onclick="exportReport()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                            üì§ TXT (Full)
                        </button>
                    </div>
                    <button id="btnAskAI" onclick="askGemini()" class="w-full bg-purple-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• (AI)
                    </button>
                    <div id="aiLoading" class="hidden text-center mt-2"><div class="loading-spinner"></div></div>
                    <div id="aiResult" class="hidden mt-2 text-xs bg-purple-50 p-2 rounded markdown-body"></div>
                </div>
            </div>
            <div class="p-2 bg-gray-100 text-center no-print"><button onclick="closeResult()" class="w-full bg-gray-300 py-2 rounded text-gray-700 font-bold">‡∏õ‡∏¥‡∏î</button></div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historySection" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
            <div class="bg-indigo-700 p-3 text-white flex justify-between items-center sticky top-0">
                <h2 class="font-bold">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                <button onclick="document.getElementById('historySection').classList.add('hidden')" class="text-white text-xl">&times;</button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="historyListContainer" class="space-y-3"></div>
                <div id="historyDetailContainer" class="hidden">
                    <button onclick="showHistoryList()" class="mb-3 text-xs text-indigo-600 flex items-center gap-1">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    <div id="historyDetailContent" class="space-y-3"></div>
                </div>
                <div id="emptyHistory" class="text-center text-gray-400 py-8 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
            </div>
            <div class="p-3 bg-gray-100 text-center border-t">
                <button onclick="document.getElementById('historySection').classList.add('hidden')" class="w-full bg-gray-300 py-2 rounded text-gray-700 font-bold">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('record_date').valueAsDate = new Date();

        const products = [
            {id:'s', name:'‡∏Å‡∏∏‡πâ‡∏á(S)', desc:'‡∏ñ‡∏∏‡∏á24', color:'text-orange-600', unit:24},
            {id:'c', name:'‡πÑ‡∏Å‡πà(C)', desc:'‡∏ñ‡∏∏‡∏á32', color:'text-yellow-600', unit:32},
            {id:'p', name:'‡∏´‡∏°‡∏π(P)', desc:'‡∏ñ‡∏∏‡∏á32', color:'text-pink-600', unit:32},
            {id:'v', name:'‡∏ú‡∏±‡∏Å(V)', desc:'‡∏ñ‡∏∏‡∏á30', color:'text-green-600', unit:30},
            {id:'bb', name:'BBQ', desc:'‡∏ñ‡∏∏‡∏á20', color:'text-red-700', unit:20},
            {id:'b', name:'‡∏û‡∏£‡∏¥‡∏Å(B)', desc:'‡∏ñ‡∏∏‡∏á20', color:'text-gray-600', unit:20}
        ];
        
        // UI Generation
        const stockHTML = products.map(p => `
            <div class="stock-grid">
                <div class="text-xs font-bold ${p.color}">${p.name}<br><span class="text-[9px] text-gray-400 font-normal">${p.desc}</span></div>
                <div class="dual-input"><input type="number" id="${p.id}_prev_bag" placeholder="‡∏ñ" class="input-field bg-gray-50" onchange="autoSave()"><input type="number" id="${p.id}_prev_unit" placeholder="‡∏®" class="input-field bg-gray-50" onchange="autoSave()"></div>
                <div class="dual-input"><input type="number" id="${p.id}_add_bag" placeholder="‡∏ñ" class="input-field bg-blue-50" onchange="autoSave()"><input type="number" id="${p.id}_add_unit" placeholder="‡∏®" class="input-field bg-blue-50" onchange="autoSave()"></div>
                <div class="dual-input"><input type="number" id="${p.id}_end_bag" placeholder="‡∏ñ" class="input-field bg-red-50" onchange="autoSave()"><input type="number" id="${p.id}_end_unit" placeholder="‡∏®" class="input-field bg-red-50" onchange="autoSave()"></div>
            </div>
        `).join('');
        document.getElementById('stockContainer').innerHTML = stockHTML;

        const whHTML = products.map(p => `
            <div class="mb-2 pb-2 border-b border-gray-100 last:border-0">
                <div class="wh-grid">
                    <div class="text-xs font-bold ${p.color}">${p.name}</div>
                    <input type="number" id="wh_${p.id}_bag" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á" class="input-field bg-purple-50 text-purple-900" onchange="calculateWarehouse()">
                    <input type="number" id="wh_${p.id}_cost" placeholder="‡∏ó‡∏∏‡∏ô/‡∏ñ‡∏∏‡∏á" class="input-field bg-white border-purple-200" onchange="calculateWarehouse()">
                </div>
                <div class="flex justify-between text-[10px] text-gray-400 px-2">
                    <span>‡∏´‡∏±‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô: <span id="wh_deduct_${p.id}" class="text-red-500 font-bold">0</span> ‡∏ñ‡∏∏‡∏á</span>
                    <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á: <span id="wh_rem_${p.id}" class="text-green-600 font-bold">0</span> ‡∏ñ‡∏∏‡∏á</span>
                </div>
            </div>
        `).join('');
        document.getElementById('warehouseContainer').innerHTML = whHTML;

        const allInputs = ['shop_name', 'staff_name', 'record_date', 'cash', 'transfer', 'daily_expense', 'waste_dumpling', 'waste_bbq', 'individual_10_count', 'set150_count', 'set250_count', 'set290_count', 'fixed_cost_custom'];
        allInputs.forEach(id => document.getElementById(id).addEventListener('change', autoSave));

        // Logic
        function calculateWarehouse() {
            let totalWhValue = 0;
            products.forEach(p => {
                let whStockBags = getVal(`wh_${p.id}_bag`);
                let whCostPerBag = getVal(`wh_${p.id}_cost`);
                let addBag = getVal(`${p.id}_add_bag`);
                let addUnit = getVal(`${p.id}_add_unit`);
                let addTotalBags = addBag + (addUnit / p.unit);
                
                let remainingBags = Math.max(0, whStockBags - addTotalBags);
                let remainingValue = remainingBags * whCostPerBag;
                document.getElementById(`wh_deduct_${p.id}`).innerText = addTotalBags > 0 ? addTotalBags.toFixed(2) : "0";
                document.getElementById(`wh_rem_${p.id}`).innerText = remainingBags.toFixed(2);
                totalWhValue += remainingValue;
            });
            document.getElementById('wh_total_value').innerText = `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: ${totalWhValue.toLocaleString()} ‡∏ø`;
            autoSave();
            return totalWhValue;
        }

        function autoSave() {
            const data = {};
            products.forEach(p => {
                ['prev', 'add', 'end'].forEach(type => {
                    data[`${p.id}_${type}_bag`] = document.getElementById(`${p.id}_${type}_bag`).value;
                    data[`${p.id}_${type}_unit`] = document.getElementById(`${p.id}_${type}_unit`).value;
                });
                data[`wh_${p.id}_bag`] = document.getElementById(`wh_${p.id}_bag`).value;
                data[`wh_${p.id}_cost`] = document.getElementById(`wh_${p.id}_cost`).value;
            });
            allInputs.forEach(id => data[id] = document.getElementById(id).value);
            data['fixed_cost_select'] = document.getElementById('fixed_cost_select').value;
            localStorage.setItem('shop_v19_2_data', JSON.stringify(data));
            document.getElementById('saveStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Auto " + new Date().toLocaleTimeString();
        }

        function loadAutoSave() {
            const saved = localStorage.getItem('shop_v19_2_data');
            if(saved) {
                const data = JSON.parse(saved);
                products.forEach(p => {
                    ['prev', 'add', 'end'].forEach(type => {
                        setVal(`${p.id}_${type}_bag`, data[`${p.id}_${type}_bag`]);
                        setVal(`${p.id}_${type}_unit`, data[`${p.id}_${type}_unit`]);
                    });
                    setVal(`wh_${p.id}_bag`, data[`wh_${p.id}_bag`]);
                    setVal(`wh_${p.id}_cost`, data[`wh_${p.id}_cost`]);
                });
                allInputs.forEach(id => setVal(id, data[id]));
                if(data['fixed_cost_select']) {
                    document.getElementById('fixed_cost_select').value = data['fixed_cost_select'];
                    toggleCustomFixedCost();
                }
                calculateWarehouse();
            }
        }

        function clearAllData() {
            if(confirm('‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                localStorage.removeItem('shop_v19_2_data');
                localStorage.removeItem('shop_history');
                location.reload();
            }
        }

        function getApiKey() { return localStorage.getItem('gemini_api_key'); }
        function getScriptUrl() { 
            return localStorage.getItem('google_script_url'); 
        }
        
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const url = document.getElementById('scriptUrlInput').value.trim();
            if(key) localStorage.setItem('gemini_api_key', key);
            if(url) localStorage.setItem('google_script_url', url);
            document.getElementById('keyStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
            document.getElementById('apiKeyWarning').classList.add('hidden');
        }
        function toggleSettings() { document.getElementById('settingsArea').classList.toggle('hidden'); }
        
        if(getApiKey()) document.getElementById('apiKeyInput').value = getApiKey();
        if(getScriptUrl()) document.getElementById('scriptUrlInput').value = getScriptUrl();

        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        function updateStatus() {
            const el = document.getElementById('connectionStatus');
            if(navigator.onLine) { el.className = 'status-online'; el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'; } 
            else { el.className = 'status-offline'; el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-600"></span> ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'; }
        }

        window.stockData = { base64: null, mime: null };
        window.salesData = { base64: null, mime: null };

        function previewFile(input, type) {
            const imgBox = document.getElementById(type === 'stock' ? 'previewContainerStock' : 'previewContainerSales');
            const img = document.getElementById(type === 'stock' ? 'imgStock' : 'imgSales');
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function() {
                img.src = reader.result; imgBox.style.display = 'block';
                try {
                    const base64 = reader.result.split(',')[1];
                    const mime = reader.result.split(',')[0].match(/:(.*?);/)[1];
                    if(type === 'stock') window.stockData = { base64, mime }; else window.salesData = { base64, mime };
                } catch (e) { alert("‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤"); }
            }
            reader.readAsDataURL(file);
        }

        function closeImage(e, type) {
            e.stopPropagation();
            document.getElementById(type === 'stock' ? 'previewContainerStock' : 'previewContainerSales').style.display = 'none';
            if (type === 'stock') { document.getElementById('stock_cam').value = ""; document.getElementById('stock_file').value = ""; window.stockData = { base64: null, mime: null }; } 
            else { document.getElementById('sales_cam').value = ""; document.getElementById('sales_file').value = ""; window.salesData = { base64: null, mime: null }; }
        }

        function closeResult() {
            document.getElementById('resultSection').classList.add('hidden');
            const aiResult = document.getElementById('aiResult');
            if (aiResult) aiResult.classList.add('hidden');
            const btnAskAI = document.getElementById('btnAskAI');
            if (btnAskAI) btnAskAI.classList.remove('hidden');
        }
        function toggleCustomFixedCost() {
            document.getElementById('fixed_cost_custom').classList.toggle('hidden', document.getElementById('fixed_cost_select').value !== 'custom');
            autoSave();
        }
        function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
        function setVal(id, val) { if(val !== null && val !== undefined) document.getElementById(id).value = val; }

        let globalData = {};

        function calculateStock(pfx, unitPerBag) {
            let prev = (getVal(pfx+'_prev_bag') * unitPerBag) + getVal(pfx+'_prev_unit');
            let add = (getVal(pfx+'_add_bag') * unitPerBag) + getVal(pfx+'_add_unit');
            let end = (getVal(pfx+'_end_bag') * unitPerBag) + getVal(pfx+'_end_unit');
            return Math.max(0, (prev + add) - end);
        }

        function calculateProfit() {
            let totalWhValue = calculateWarehouse();
            let whDetails = [];
            products.forEach(p => {
                let whStockBags = getVal(`wh_${p.id}_bag`);
                let whCostPerBag = getVal(`wh_${p.id}_cost`);
                let addBag = getVal(`${p.id}_add_bag`);
                let addUnit = getVal(`${p.id}_add_unit`);
                let addTotalBags = addBag + (addUnit / p.unit);
                let remainingBags = Math.max(0, whStockBags - addTotalBags);
                let remainingValue = remainingBags * whCostPerBag;
                whDetails.push({ name: p.name, rem: remainingBags, cost: whCostPerBag, val: remainingValue });
            });

            let cash = getVal('cash'), transfer = getVal('transfer'), daily = getVal('daily_expense');
            let actual_rev = cash + transfer + daily;

            let s = calculateStock('s', 24), c = calculateStock('c', 32), p = calculateStock('p', 32), v = calculateStock('v', 30);
            let bb = calculateStock('bb', 20), b = calculateStock('b', 20);

            let dump_waste = getVal('waste_dumpling'), bbq_waste = getVal('waste_bbq');
            let set150 = getVal('set150_count'), set290 = getVal('set290_count'), set250 = getVal('set250_count');
            let individual10 = getVal('individual_10_count');

            let dump_sales_val = (s+c+p+v - dump_waste) * 13;
            let bbq_sales_val = (bb+b - bbq_waste) * 50;
            
            let expected = dump_sales_val + bbq_sales_val;
            let surcharge = (set150 * 20) + (set290 * 30);
            let discount = (set250 * 10) + (individual10 * 3);
            let adjusted_actual = actual_rev - surcharge + discount;

            let costDumplings = (s+c+p+v) * 6.5;
            let costBBQ = (bb+b) * 24;
            let fixed = document.getElementById('fixed_cost_select').value === 'custom' ? getVal('fixed_cost_custom') : parseFloat(document.getElementById('fixed_cost_select').value);
            let totalCost = costDumplings + costBBQ + fixed + daily;
            let profit = actual_rev - totalCost;
            
            let totalDumplingsSold = s + c + p + v;
            let totalBBQSold = bb + b;

            let whReportList = "";
            whDetails.forEach(i => {
                whReportList += `<div class="flex justify-between"><span>${i.name}:</span> <span>${i.rem.toFixed(2)} ‡∏ñ‡∏∏‡∏á</span></div>`;
            });

            let diff = adjusted_actual - expected;
            let statusText = "‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á";
            if (Math.abs(diff) >= 50) statusText = diff > 0 ? "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô" : "‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢";

            globalData = { 
                actual_rev, profit, diff: adjusted_actual - expected, 
                items: {s,c,p,v,bb,b, dumplings: totalDumplingsSold, bbq: totalBBQSold, individual: individual10},
                adj_val: (discount - surcharge),
                costs: { dumplings: costDumplings, bbq: costBBQ, fixed: fixed, daily: daily, total: totalCost },
                warehouse: { totalVal: totalWhValue, html: whReportList, details: whDetails },
                statusText: statusText
            };
            
            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('res_expected').innerText = expected.toLocaleString();
            document.getElementById('res_actual').innerText = adjusted_actual.toLocaleString();
            document.getElementById('res_diff').innerText = (adjusted_actual - expected).toLocaleString();
            document.getElementById('res_profit').innerText = profit.toLocaleString() + " ‡∏ø";
            
            let costPct = (totalCost / (totalCost + Math.max(0,profit))) * 100;
            if(profit < 0) costPct = 100;
            document.getElementById('chart_cost_bar').style.width = `${costPct}%`;
            document.getElementById('chart_profit_bar').style.width = `${100-costPct}%`;
            document.getElementById('chart_cost_pct').innerText = `${Math.round(costPct)}%`;
            document.getElementById('chart_profit_pct').innerText = `${Math.round(100-costPct)}%`;

            document.getElementById('print_shop_name').innerText = document.getElementById('shop_name').value || "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤";
            const dateStr = new Date(document.getElementById('record_date').value).toLocaleDateString('th-TH');
            document.getElementById('print_date_staff').innerText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${document.getElementById('staff_name').value || '-'}`;

            let box = document.getElementById('audit_box');
            if(Math.abs(diff) < 50) { 
                box.className = "p-3 rounded-lg border-2 audit-pass"; 
                document.getElementById('audit_msg').innerText = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á (Perfect)";
                document.getElementById('res_diff').className = "text-xl font-bold text-green-700";
            } else if(diff > 0) { 
                box.className = "p-3 rounded-lg border-2 bg-blue-50 border-blue-200 text-blue-700"; 
                document.getElementById('audit_msg').innerText = "‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô (Surplus)";
                document.getElementById('res_diff').className = "text-xl font-bold text-blue-700";
            } else { 
                box.className = "p-3 rounded-lg border-2 audit-fail"; 
                document.getElementById('audit_msg').innerText = "‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢ (Missing)"; 
                document.getElementById('res_diff').className = "text-xl font-bold text-red-700";
            }

            document.getElementById('item_breakdown_list').innerHTML = `
                <div class="flex justify-between"><span>ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏£‡∏ß‡∏°:</span> <span>${totalDumplingsSold} ‡∏ï‡∏±‡∏ß</span></div>
                <div class="flex justify-between"><span>üç¢ BBQ‡∏£‡∏ß‡∏°:</span> <span>${totalBBQSold} ‡πÑ‡∏°‡πâ</span></div>
            `;
            
            document.getElementById('res_wh_list').innerHTML = whReportList;
            document.getElementById('res_wh_value').innerText = totalWhValue.toLocaleString();
        }

        function saveToHistory() {
            if(!globalData.profit) return alert("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            const history = JSON.parse(localStorage.getItem('shop_history') || '[]');
            const record = {
                id: Date.now(),
                date: document.getElementById('record_date').value,
                shop: document.getElementById('shop_name').value,
                staff: document.getElementById('staff_name').value,
                profit: globalData.profit,
                diff: globalData.diff,
                data: globalData,
                timestamp: new Date().toLocaleString('th-TH')
            };
            history.unshift(record); 
            localStorage.setItem('shop_history', JSON.stringify(history));
            const btn = document.getElementById('btnSaveHistory');
            btn.innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
            setTimeout(() => btn.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Save)", 2000);
        }

        function openHistory() {
            document.getElementById('historyListContainer').classList.remove('hidden');
            document.getElementById('historyDetailContainer').classList.add('hidden');
            document.getElementById('historySection').classList.remove('hidden');
            const history = JSON.parse(localStorage.getItem('shop_history') || '[]');
            const listEl = document.getElementById('historyListContainer');
            listEl.innerHTML = history.length ? '' : '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
            
            history.forEach((rec, index) => {
                const color = rec.diff == 0 ? 'text-green-600' : 'text-red-600';
                listEl.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg border flex justify-between items-center" onclick="viewHistoryDetail(${index})">
                        <div>
                            <div class="font-bold">${new Date(rec.date).toLocaleDateString('th-TH')}</div>
                            <div class="text-xs">‡∏Å‡∏≥‡πÑ‡∏£: ${rec.profit.toLocaleString()} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="${color}">${rec.diff}</span></div>
                        </div>
                        <button onclick="deleteHistory(event, ${index})" class="text-red-500">üóëÔ∏è</button>
                    </div>`;
            });
        }

        function viewHistoryDetail(index) {
            const history = JSON.parse(localStorage.getItem('shop_history') || '[]');
            const d = history[index].data;
            const whHtml = (d.warehouse && d.warehouse.html) ? d.warehouse.html : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            const individualSold = (d.items && d.items.individual) ? d.items.individual : 0;

            document.getElementById('historyDetailContent').innerHTML = `
                <div class="bg-white p-2 rounded border">
                    <div class="font-bold text-center border-b pb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(history[index].date).toLocaleDateString('th-TH')}</div>
                    <div class="flex justify-between mt-2"><span>‡∏Å‡∏≥‡πÑ‡∏£:</span> <span class="font-bold text-green-600">${d.profit.toLocaleString()}</span></div>
                    <div class="flex justify-between"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</span> <span>${d.diff}</span></div>
                    <div class="mt-2 font-bold text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</div>
                    <div class="text-xs ml-2">ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ${d.items.dumplings} ‡∏ï‡∏±‡∏ß (‡πÅ‡∏¢‡∏Å: ${individualSold})</div>
                    <div class="text-xs ml-2">üç¢ BBQ ${d.items.bbq} ‡πÑ‡∏°‡πâ</div>
                    <div class="mt-2 font-bold text-xs text-gray-500">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</div>
                    <div class="text-xs ml-2">${whHtml}</div>
                </div>
            `;
            document.getElementById('historyListContainer').classList.add('hidden');
            document.getElementById('historyDetailContainer').classList.remove('hidden');
        }
        
        function showHistoryList() {
            document.getElementById('historyListContainer').classList.remove('hidden');
            document.getElementById('historyDetailContainer').classList.add('hidden');
        }

        function deleteHistory(e, index) {
            e.stopPropagation();
            if(!confirm('‡∏•‡∏ö?')) return;
            const history = JSON.parse(localStorage.getItem('shop_history') || '[]');
            history.splice(index, 1);
            localStorage.setItem('shop_history', JSON.stringify(history));
            openHistory();
        }

        function exportReport() {
            if (!globalData.items) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            const d = new Date(document.getElementById('record_date').value);
            const dateStr = d.toLocaleDateString('th-TH');
            const shopName = document.getElementById('shop_name').value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            const staffName = document.getElementById('staff_name').value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            
            let txt = `========================================\n`;
            txt += `      ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô (Full Report)      \n`;
            txt += `========================================\n`;
            txt += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr}\n`;
            txt += `‡∏™‡∏≤‡∏Ç‡∏≤: ${shopName} | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${staffName}\n`;
            txt += `----------------------------------------\n`;
            
            // Financials
            txt += `[‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô]\n`;
            txt += `üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (Cash): ${globalData.actual_rev.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `üìâ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (Cost):   ${globalData.costs.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `‚úÖ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Profit): ${globalData.profit.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: ${globalData.statusText || 'N/A'} (${globalData.diff.toLocaleString()})\n`;
            txt += `(‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á: ${globalData.adj_val.toLocaleString()} ‡∏ö‡∏≤‡∏ó)\n`;
            txt += `----------------------------------------\n`;

            // Cost Details
            txt += `[‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô]\n`;
            txt += `- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß: ${globalData.costs.dumplings.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö BBQ:   ${globalData.costs.bbq.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `- ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà+‡πÅ‡∏£‡∏á:     ${globalData.costs.fixed.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `- ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô:     ${globalData.costs.daily.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            txt += `----------------------------------------\n`;

            // Sales Quantities
            txt += `[‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤]\n`;
            txt += `ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤‡∏£‡∏ß‡∏°: ${globalData.items.dumplings} ‡∏ï‡∏±‡∏ß\n`;
            txt += `   (‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å: ${globalData.items.individual || 0} ‡∏ï‡∏±‡∏ß)\n`;
            txt += `üç¢ BBQ ‡∏£‡∏ß‡∏°:      ${globalData.items.bbq} ‡πÑ‡∏°‡πâ\n`;
            txt += `   - ‡∏Å‡∏∏‡πâ‡∏á: ${globalData.items.s}\n`;
            txt += `   - ‡πÑ‡∏Å‡πà: ${globalData.items.c}\n`;
            txt += `   - ‡∏´‡∏°‡∏π: ${globalData.items.p}\n`;
            txt += `   - ‡∏ú‡∏±‡∏Å: ${globalData.items.v}\n`;
            txt += `   - BBQ: ${globalData.items.bb}\n`;
            txt += `   - ‡∏û‡∏£‡∏¥‡∏Å‡πÑ‡∏ó‡∏¢‡∏î‡∏≥: ${globalData.items.b}\n`;
            txt += `----------------------------------------\n`;

            // Warehouse
            txt += `[‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠]\n`;
            if(globalData.warehouse && globalData.warehouse.details) {
                globalData.warehouse.details.forEach(item => {
                    txt += `- ${item.name}: ${item.rem.toFixed(2)} ‡∏ñ‡∏∏‡∏á (‡∏ó‡∏∏‡∏ô ${item.cost}) = ${item.val.toLocaleString()} ‡∏ö.\n`;
                });
                txt += `\nüì¶ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°: ${globalData.warehouse.totalVal.toLocaleString()} ‡∏ö‡∏≤‡∏ó\n`;
            } else {
                txt += "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n";
            }
            txt += `========================================\n`;
            txt += `Created by Smart Shop V19.2`;

            const blob = new Blob(["\uFEFF" + txt], { type: "text/plain;charset=utf-8" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Full_Report_${d.toISOString().slice(0,10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function sendToGoogleSheet() {
            if (!globalData.profit) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            const scriptUrl = getScriptUrl();
            if (!scriptUrl) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Script ‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            const btn = document.getElementById('btnSendSheet');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
            btn.disabled = true;

            const payload = {
                date: new Date(document.getElementById('record_date').value).toLocaleDateString('th-TH'),
                time: new Date().toLocaleTimeString('th-TH'),
                shop: document.getElementById('shop_name').value || "-",
                staff: document.getElementById('staff_name').value || "-",
                actual_rev: globalData.actual_rev,
                profit: globalData.profit,
                status: globalData.statusText,
                diff: globalData.diff,
                sold_dump: globalData.items.dumplings,
                sold_bbq: globalData.items.bbq,
                sold_indiv: globalData.items.individual || 0,
                cost_total: globalData.costs.total,
                wh_value: globalData.warehouse.totalVal
            };

            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Important for Google Script
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                // Since mode is no-cors, we assume success if no error thrown
                alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            } catch (error) {
                console.error('Error:', error);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function extractDataFromImage() {
            const apiKey = getApiKey();
            if (!apiKey) return alert("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            document.getElementById('btnAutoFill').classList.add('hidden');
            document.getElementById('fillLoading').classList.remove('hidden');
            
            // Real Gemini Logic (Image to JSON)
            const contentParts = [{ text: `Extract handwritten shop data to JSON. Keys: cash, transfer, daily_expense, set150_count, set250_count, set290_count, individual_10_count, s_prev_bag, s_prev_unit, s_add_bag, s_add_unit, s_end_bag, s_end_unit... (same logic as before). Output JSON only.` }];
            
            if (window.stockData.base64) contentParts.push({ inlineData: { mimeType: window.stockData.mime, data: window.stockData.base64 } });
            if (window.salesData.base64) contentParts.push({ inlineData: { mimeType: window.salesData.mime, data: window.salesData.base64 } });

            if (!window.stockData.base64 && !window.salesData.base64) {
                 // Fallback Mock if no image
                 setTimeout(() => {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á)");
                    document.getElementById('fillLoading').classList.add('hidden');
                    document.getElementById('btnAutoFill').classList.remove('hidden');
                }, 1000);
                return;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ role: "user", parts: contentParts }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                let txt = data.candidates[0].content.parts[0].text;
                const jsonMatch = txt.match(/\{[\s\S]*\}/);
                if (jsonMatch) txt = jsonMatch[0];
                const j = JSON.parse(txt);

                // Populate Fields
                ['cash','transfer','daily_expense', 'set150_count', 'set290_count', 'set250_count', 'individual_10_count'].forEach(k => setVal(k, j[k]));
                products.forEach(p => {
                    ['prev','add','end'].forEach(type => {
                        setVal(`${p.id}_${type}_bag`, j[`${p.id}_${type}_bag`]);
                        setVal(`${p.id}_${type}_unit`, j[`${p.id}_${type}_unit`]);
                    });
                });
                
                alert("AI ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!");
                autoSave();
            } catch(e) { 
                console.error(e); 
                alert("AI Error: " + e.message); 
            }
            
            document.getElementById('fillLoading').classList.add('hidden');
            document.getElementById('btnAutoFill').classList.remove('hidden');
        }

        async function askGemini() {
            if (!navigator.onLine) return alert("‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏Ñ‡∏£‡∏±‡∏ö");
            const apiKey = getApiKey();
            if (!apiKey) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            document.getElementById('btnAskAI').classList.add('hidden');
            document.getElementById('aiLoading').classList.remove('hidden');
            const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤: ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ${globalData.actual_rev}, ‡∏Å‡∏≥‡πÑ‡∏£ ${globalData.profit}, ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ${globalData.items.dumplings} ‡∏ï‡∏±‡∏ß, BBQ ${globalData.items.bbq} ‡πÑ‡∏°‡πâ), ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${JSON.stringify(globalData.remaining)}. ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡∏ô‡∏∏‡∏Å‡πÜ`;
             try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const txt = data.candidates[0].content.parts[0].text;
                document.getElementById('aiResult').innerHTML = marked.parse(txt);
                document.getElementById('aiResult').classList.remove('hidden');
            } catch(e) { console.log(e); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î AI: " + e.message); }
            document.getElementById('aiLoading').classList.add('hidden');
        }

        loadAutoSave();
    </script>
</body>
</html>
