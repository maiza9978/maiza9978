<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô V22.2 (AI Real Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f9ff; padding-bottom: 120px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 0.2rem; text-align: center; }
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.4rem; font-size: 1rem; text-align: center; font-weight: 500; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px solid #bfdbfe; }
        .input-field:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .section-header { font-size: 1.1rem; font-weight: bold; color: #0f172a; margin-bottom: 0.8rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        
        .stock-grid { display: grid; grid-template-columns: 1fr 1.5fr 1.5fr 1.5fr; gap: 4px; align-items: end; margin-bottom: 8px; }
        .dual-input { display: flex; gap: 2px; }
        .dual-input input { width: 50%; font-size: 0.9rem; }
        
        .wh-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .img-preview-box { display: none; margin-top: 5px; text-align: center; background: #e2e8f0; border-radius: 8px; padding: 4px; position: relative; }
        .img-preview-box img { max-height: 120px; max-width: 100%; border-radius: 4px; border: 2px solid white; display: inline-block; }
        .close-btn { background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; position: absolute; top: -5px; right: -5px; cursor: pointer; line-height: 20px; font-size: 12px; }

        .audit-pass { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .audit-fail { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        #connectionStatus { font-size: 0.8rem; padding: 4px 12px; border-radius: 20px; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; }
        .status-online { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-offline { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }

        @media print {
            body { background-color: white; padding: 0; }
            .no-print, .card, #connectionStatus, #saveStatus, button { display: none !important; }
            #resultSection { position: static; display: block !important; background: white; width: 100%; max-width: 100%; box-shadow: none; overflow: visible; }
            #resultSection > div { width: 100%; max-width: 100%; box-shadow: none; border: none; }
            #resultSection .bg-gray-800 { background: white !important; color: black !important; border-bottom: 2px solid black; }
            #resultSection .text-white { color: black !important; }
            #printHeader { display: block !important; text-align: center; margin-bottom: 20px; }
            .markdown-body { display: none; }
        }
    </style>
</head>
<body class="p-3 max-w-xl mx-auto">

    <div class="flex justify-between items-center mb-4 no-print">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">ü•ü ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô V22.2</h1>
            <p id="saveStatus" class="text-xs text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>
        <div class="flex flex-col items-end gap-1">
            <div id="connectionStatus" class="status-online">
                <span class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            </div>
            <button onclick="openHistory()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-200 hover:bg-indigo-100 flex items-center gap-1">
                üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
            </button>
        </div>
    </div>

    <!-- Shop Info -->
    <div class="card border-t-4 border-slate-600 no-print">
        <div class="section-header text-slate-700">üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô</div>
        <div class="grid grid-cols-2 gap-3">
            <div><label class="input-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</label><input type="text" id="shop_name" class="input-field bg-slate-50" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏Ç‡∏≤‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß"></div>
            <div><label class="input-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input type="text" id="staff_name" class="input-field bg-slate-50" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"></div>
        </div>
        <div class="mt-2"><label class="input-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="record_date" class="input-field bg-slate-50"></div>
    </div>

    <!-- Upload Section -->
    <div class="grid grid-cols-2 gap-3 mb-4 no-print">
        <div class="bg-white border-2 border-dashed border-indigo-300 rounded-xl p-3 text-center hover:bg-indigo-50">
            <div class="text-2xl mb-1">üì¶</div>
            <p class="font-bold text-indigo-700 text-xs mb-2">1. ‡πÉ‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
            <div class="flex gap-2 justify-center">
                <button onclick="document.getElementById('stock_cam').click()" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-200 flex items-center gap-1 border border-indigo-200">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢</button>
                <button onclick="document.getElementById('stock_file').click()" class="bg-white text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-50 flex items-center gap-1 border border-indigo-200">üìÅ ‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            <input type="file" id="stock_cam" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this, 'stock')">
            <input type="file" id="stock_file" accept="image/*" class="hidden" onchange="previewFile(this, 'stock')">
            <div id="previewContainerStock" class="img-preview-box">
                <button class="close-btn" onclick="closeImage(event, 'stock')">√ó</button>
                <img id="imgStock" src="">
            </div>
        </div>
        <div class="bg-white border-2 border-dashed border-green-300 rounded-xl p-3 text-center hover:bg-green-50">
            <div class="text-2xl mb-1">üí∞</div>
            <p class="font-bold text-green-700 text-xs mb-2">2. ‡πÉ‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</p>
            <div class="flex gap-2 justify-center">
                <button onclick="document.getElementById('sales_cam').click()" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200 flex items-center gap-1 border border-green-200">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢</button>
                <button onclick="document.getElementById('sales_file').click()" class="bg-white text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-50 flex items-center gap-1 border border-green-200">üìÅ ‡πÑ‡∏ü‡∏•‡πå</button>
            </div>
            <input type="file" id="sales_cam" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this, 'sales')">
            <input type="file" id="sales_file" accept="image/*" class="hidden" onchange="previewFile(this, 'sales')">
            <div id="previewContainerSales" class="img-preview-box">
                <button class="close-btn" onclick="closeImage(event, 'sales')">√ó</button>
                <img id="imgSales" src="">
            </div>
        </div>
    </div>

    <!-- AI Button -->
    <div id="aiSection" class="mb-4 no-print">
        <button id="btnAutoFill" onclick="extractDataFromImage()" class="w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white font-bold py-3 rounded-xl text-sm shadow-md hover:opacity-90 transition flex items-center justify-center gap-2 transform active:scale-95">
            ‚ú® ‡πÉ‡∏´‡πâ AI Gemini ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á)
        </button>
        <div id="fillLoading" class="hidden text-center py-4 bg-white rounded-xl border border-indigo-100">
            <div class="loading-spinner"></div>
            <p class="text-indigo-600 text-xs mt-2 font-bold animate-pulse">Gemini ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠...</p>
        </div>
        <div id="apiKeyWarning" class="hidden text-center text-red-500 text-xs mt-2 bg-red-50 p-2 rounded border border-red-200">‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI</div>
    </div>

    <!-- 1. Stock Check Table -->
    <div class="card border-t-4 border-indigo-500 no-print" id="cardStock">
        <div class="section-header text-indigo-700">
            <span>üì¶ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
        </div>
        <div id="stockContent">
            <div class="stock-grid text-[10px] text-gray-500 font-bold text-center bg-gray-50 p-1 rounded-t">
                <div class="text-left pl-1">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div> <div>‡πÄ‡∏Å‡πà‡∏≤</div> <div class="text-blue-600">‡πÄ‡∏ï‡∏¥‡∏°</div> <div class="text-red-600">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            </div>
            <div class="space-y-2" id="stockContainer"></div>
        </div>
    </div>

    <!-- 2. Warehouse Stock -->
    <div class="card border-t-4 border-purple-500 no-print transition-colors" id="cardWarehouse">
        <div class="section-header text-purple-700 flex justify-between items-center">
            <span>üè≠ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
            <div class="flex items-center gap-2">
                <label class="text-xs text-gray-500 font-normal">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</label>
                <input type="checkbox" id="calc_warehouse_toggle" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500" checked onchange="toggleWarehouseCalculation()">
            </div>
        </div>
        <div id="warehouseContent">
             <div class="text-right text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full mb-2 inline-block ml-auto w-full" id="wh_total_value">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤: 0 ‡∏ø</div>
             <div class="text-[10px] text-gray-500 mb-2">* ‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î "‡πÄ‡∏ï‡∏¥‡∏°" ‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á</div>
             <div class="wh-grid font-bold text-[10px] text-gray-500 text-center bg-gray-50 p-1 rounded-t">
                <div class="text-left pl-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div> <div>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô (‡∏ñ‡∏∏‡∏á)</div> <div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏ñ‡∏∏‡∏á</div>
             </div>
             <div class="space-y-3" id="warehouseContainer"></div>
        </div>
        <div id="warehouseDisabledMsg" class="hidden text-center text-gray-400 text-sm py-4 bg-gray-50 rounded">
            üö´ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ
        </div>
    </div>

    <!-- 3. Money Table -->
    <div class="card border-t-4 border-green-500 no-print">
        <div class="section-header text-green-700">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö & ‡∏à‡πà‡∏≤‡∏¢</div>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div><label class="input-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡πÉ‡∏ô‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å)</label><input type="number" id="cash" class="input-field bg-green-50" placeholder="0"></div>
            <div><label class="input-label">‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô (K)</label><input type="number" id="transfer" class="input-field bg-blue-50" placeholder="0"></div>
        </div>
        <div class="mb-2"><label class="input-label text-red-600">üí∏ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å)</label><input type="number" id="daily_expense" class="input-field bg-red-50" placeholder="65"></div>
        <select id="fixed_cost_select" onchange="toggleCustomFixedCost()" class="w-full text-sm border p-1 rounded bg-gray-50">
            <option value="815">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà+‡πÅ‡∏£‡∏á (815 ‡∏ö.)</option>
            <option value="custom">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á...</option>
        </select>
        <input type="number" id="fixed_cost_custom" class="input-field hidden mt-1" placeholder="‡∏£‡∏∞‡∏ö‡∏∏">
    </div>

    <!-- 4. Waste & Topping -->
    <div class="card border-t-4 border-yellow-400 no-print">
        <div class="section-header text-yellow-700">‚ö†Ô∏è ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢ & Top</div>
        <div class="grid grid-cols-3 gap-3">
            <div><label class="input-label text-xs">‡πÄ‡∏™‡∏µ‡∏¢:‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß</label><input type="number" id="waste_dumpling" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">‡πÄ‡∏™‡∏µ‡∏¢:BBQ</label><input type="number" id="waste_bbq" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs text-blue-600">‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å (‡∏ï‡∏±‡∏ß‡∏•‡∏∞10)</label><input type="number" id="individual_10_count" class="input-field bg-blue-50" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"></div>
            <div><label class="input-label text-xs">Set 150 (10‡∏ï‡∏±‡∏ß)</label><input type="number" id="set150_count" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">Set 250 (20‡∏ï‡∏±‡∏ß)</label><input type="number" id="set250_count" class="input-field" placeholder="0"></div>
            <div><label class="input-label text-xs">Set 290 (20‡∏ï‡∏±‡∏ß)</label><input type="number" id="set290_count" class="input-field" placeholder="0"></div>
        </div>
    </div>

    <button onclick="calculateProfit()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:scale-[1.02] transition mb-8 no-print">
        ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
    </button>

    <!-- Settings -->
    <div class="card border-t-4 border-gray-400 bg-gray-50 mb-8 no-print">
        <div class="section-header text-gray-700 flex justify-between" onclick="toggleSettings()">
            <span>üîë ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API Key & Link</span>
            <span class="text-xs text-blue-500 underline cursor-pointer">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î</span>
        </div>
        <div id="settingsArea" class="hidden">
            <p class="text-xs text-gray-500 mb-1">Gemini API Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI)</p>
            <input type="password" id="apiKeyInput" class="w-full border p-2 rounded mb-3 text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ AIza... ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
            
            <p class="text-xs text-gray-500 mb-1">Google Script URL (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏µ‡∏ï)</p>
            <input type="text" id="scriptUrlInput" class="w-full border p-2 rounded mb-3 text-sm" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå https://script.google.com/.../exec">
            
            <button onclick="saveApiKey()" class="w-full bg-gray-600 text-white py-1 rounded text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            <p id="keyStatus" class="text-xs text-center mt-2 text-gray-400"></p>
            
            <div class="mt-4 pt-4 border-t">
                <button onclick="clearAllData()" class="w-full text-red-500 text-xs border border-red-200 rounded py-1 hover:bg-red-50">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultSection" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[90vh] overflow-y-auto">
            <div class="bg-gray-800 p-3 text-white flex justify-between items-center sticky top-0 no-print">
                <h2 class="font-bold">üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î</h2>
                <button onclick="closeResult()" class="text-white text-xl">&times;</button>
            </div>
            
            <div id="printHeader" style="display:none;" class="text-center mb-4 pt-4">
                <h1 class="text-xl font-bold">‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h1>
                <p id="print_shop_name" class="text-sm"></p>
                <p id="print_date_staff" class="text-xs text-gray-500"></p>
                <hr class="my-2 border-gray-300">
            </div>

            <div class="p-4 space-y-3 text-sm">
                <!-- Audit -->
                <div id="audit_box" class="p-3 rounded-lg border-2">
                    <h3 class="font-bold flex gap-2 no-print"><span id="audit_icon"></span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <div class="flex justify-between mt-1 items-end">
                        <span class="text-gray-600 text-xs">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á (Net Sold):</span> 
                        <span id="res_expected" class="font-bold text-base">0</span>
                    </div>
                    <div class="flex justify-between border-b pb-1 items-end">
                        <span class="text-gray-600 text-xs">‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (‡∏´‡∏±‡∏ÅTop/‡∏ö‡∏ß‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î):</span> 
                        <span id="res_actual" class="text-blue-600 font-bold text-base">0</span>
                    </div>
                    <div class="flex justify-between mt-2 items-center bg-gray-50 p-2 rounded">
                        <span class="font-bold text-gray-800">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á:</span> 
                        <span id="res_diff" class="text-xl font-bold">0</span>
                    </div>
                    <div class="text-[10px] text-gray-400 text-center mt-1 no-print">
                        (‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á = <span id="res_raw_cash">0</span> [‡∏™‡∏î <span id="res_cash_only">0</span>] | ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á = <span id="res_adj_val">0</span>)
                    </div>
                    <p id="audit_msg" class="text-sm font-bold text-center mt-2"></p>
                </div>
                
                <!-- Profit -->
                <div class="text-center bg-green-50 p-3 rounded-lg border border-green-200">
                    <p class="text-green-800 font-bold">üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</p>
                    <div id="res_profit" class="text-3xl font-bold text-green-600">0</div>
                    <!-- Chart -->
                    <div id="profit_chart_container">
                         <div class="w-full bg-red-200 rounded-full h-2.5 mt-3 overflow-hidden flex">
                            <div id="chart_cost_bar" class="bg-red-500 h-2.5" style="width: 50%"></div>
                            <div id="chart_profit_bar" class="bg-green-500 h-2.5" style="width: 50%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                            <span>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° <span id="chart_cost_pct">50%</span></span>
                            <span>‡∏Å‡∏≥‡πÑ‡∏£ <span id="chart_profit_pct">50%</span></span>
                        </div>
                    </div>
                </div>

                <!-- Cost Summary (Real Cost V21.5 Fixed) -->
                <div class="bg-red-50 p-3 rounded-lg border border-red-200 mt-2" id="cost_summary_box">
                    <p class="font-bold text-red-800 mb-2 border-b border-red-200 pb-1 flex justify-between">
                        <span>üìâ ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (Total Cost):</span>
                        <span id="res_total_cost">0 ‡∏ø</span>
                    </p>
                    <div class="text-xs text-red-700 space-y-1">
                        <div class="flex justify-between"><span>- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß (6.5‡∏ö. x <span id="res_count_dump_total">0</span>):</span> <span><span id="res_cost_dump">0</span> ‡∏ø</span></div>
                        <div class="flex justify-between"><span>- ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö BBQ (24‡∏ö. x <span id="res_count_bbq_total">0</span>):</span> <span><span id="res_cost_bbq">0</span> ‡∏ø</span></div>
                        <div class="border-t border-red-200 my-1"></div>
                        <div class="flex justify-between font-bold"><span>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ:</span> <span id="res_total_other_cost">0 ‡∏ø</span></div>
                         <div class="flex justify-between"><span>- ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà+‡πÅ‡∏£‡∏á (Fixed):</span> <span><span id="res_cost_fixed">0</span> ‡∏ø</span></div>
                        <div class="flex justify-between"><span>- ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily):</span> <span><span id="res_cost_daily">0</span> ‡∏ø</span></div>
                    </div>
                </div>

                <!-- Warehouse Summary -->
                <div class="bg-purple-50 p-3 rounded-lg border border-purple-200 mt-2" id="wh_summary_box">
                    <p class="font-bold text-purple-900 mb-2 border-b border-purple-200 pb-1">üè≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠):</p>
                    <div id="res_wh_list" class="space-y-1 text-xs text-purple-800"></div>
                    <div class="mt-2 text-right font-bold text-purple-900 text-sm">‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="res_wh_value">0</span> ‡∏ø</div>
                </div>

                <!-- Sales Breakdown -->
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200" id="sales_summary_box">
                    <p class="font-bold text-gray-700 mb-2 border-b pb-1">üõí ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Sold vs Waste):</p>
                    <div class="text-xs text-gray-600 space-y-2">
                        <div class="flex justify-between">
                            <span>ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß: ‡∏Ç‡∏≤‡∏¢ <b id="res_sold_dump">0</b> | ‡πÄ‡∏™‡∏µ‡∏¢ <b class="text-red-500" id="res_waste_dump">0</b></span>
                            <span>(‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: <span id="res_usage_dump">0</span>)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üç¢ BBQ: ‡∏Ç‡∏≤‡∏¢ <b id="res_sold_bbq">0</b> | ‡πÄ‡∏™‡∏µ‡∏¢ <b class="text-red-500" id="res_waste_bbq">0</b></span>
                             <span>(‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡πÑ‡∏õ: <span id="res_usage_bbq">0</span>)</span>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-2 pt-2 border-t space-y-2 no-print">
                    <button onclick="saveToHistory()" id="btnSaveHistory" class="w-full bg-emerald-600 text-white py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-lg animate-pulse">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Local)
                    </button>
                    <!-- Google Sheet Button -->
                    <button onclick="sendToGoogleSheet()" id="btnSendSheet" class="w-full bg-green-600 text-white py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-lg">
                        üìä ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.print()" class="w-full bg-slate-700 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå/PDF
                        </button>
                        <button onclick="exportReport()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                            üì§ TXT (Full)
                        </button>
                    </div>
                    <button id="btnAskAI" onclick="askGemini()" class="w-full bg-purple-600 text-white py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• (AI)
                    </button>
                    <div id="aiLoading" class="hidden text-center mt-2"><div class="loading-spinner"></div></div>
                    <div id="aiResult" class="hidden mt-2 text-xs bg-purple-50 p-2 rounded markdown-body"></div>
                </div>
            </div>
            <div class="p-2 bg-gray-100 text-center no-print"><button onclick="closeResult()" class="w-full bg-gray-300 py-2 rounded text-gray-700 font-bold">‡∏õ‡∏¥‡∏î</button></div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historySection" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
            <div class="bg-indigo-700 p-3 text-white flex justify-between items-center sticky top-0">
                <h2 class="font-bold">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
                <button onclick="document.getElementById('historySection').classList.add('hidden')" class="text-white text-xl">&times;</button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="historyListContainer" class="space-y-3"></div>
                <div id="historyDetailContainer" class="hidden">
                    <button onclick="showHistoryList()" class="mb-3 text-xs text-indigo-600 flex items-center gap-1">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    <div id="historyDetailContent" class="space-y-3"></div>
                </div>
                <div id="emptyHistory" class="text-center text-gray-400 py-8 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>
            </div>
            <div class="p-3 bg-gray-100 text-center border-t">
                <button onclick="document.getElementById('historySection').classList.add('hidden')" class="w-full bg-gray-300 py-2 rounded text-gray-700 font-bold">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('record_date').valueAsDate = new Date();
        
        // DEFAULT LINK SETTING
        const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwokSJaBZCb0nW7f4UIDSLksehfffnkxtOFHZ-o6t1-hD8WQ0pVigUHJ9-8rrs2XeNP/exec";

        const products = [
            {id:'s', name:'‡∏Å‡∏∏‡πâ‡∏á(S)', desc:'‡∏ñ‡∏∏‡∏á24', color:'text-orange-600', unit:24},
            {id:'c', name:'‡πÑ‡∏Å‡πà(C)', desc:'‡∏ñ‡∏∏‡∏á32', color:'text-yellow-600', unit:32},
            {id:'p', name:'‡∏´‡∏°‡∏π(P)', desc:'‡∏ñ‡∏∏‡∏á32', color:'text-pink-600', unit:32},
            {id:'v', name:'‡∏ú‡∏±‡∏Å(V)', desc:'‡∏ñ‡∏∏‡∏á30', color:'text-green-600', unit:30},
            {id:'bb', name:'BBQ', desc:'‡∏ñ‡∏∏‡∏á20', color:'text-red-700', unit:20},
            {id:'b', name:'‡∏û‡∏£‡∏¥‡∏Å(B)', desc:'‡∏ñ‡∏∏‡∏á20', color:'text-gray-600', unit:20}
        ];
        
        // UI Generation
        const stockHTML = products.map(p => `
            <div class="stock-grid">
                <div class="text-xs font-bold ${p.color}">${p.name}<br><span class="text-[9px] text-gray-400 font-normal">${p.desc}</span></div>
                <div class="dual-input"><input type="number" id="${p.id}_prev_bag" placeholder="‡∏ñ" class="input-field bg-gray-50 input-stock" onchange="autoSave()"><input type="number" id="${p.id}_prev_unit" placeholder="‡∏®" class="input-field bg-gray-50 input-stock" onchange="autoSave()"></div>
                <div class="dual-input"><input type="number" id="${p.id}_add_bag" placeholder="‡∏ñ" class="input-field bg-blue-50 input-stock" onchange="autoSave()"><input type="number" id="${p.id}_add_unit" placeholder="‡∏®" class="input-field bg-blue-50 input-stock" onchange="autoSave()"></div>
                <div class="dual-input"><input type="number" id="${p.id}_end_bag" placeholder="‡∏ñ" class="input-field bg-red-50 input-stock" onchange="autoSave()"><input type="number" id="${p.id}_end_unit" placeholder="‡∏®" class="input-field bg-red-50 input-stock" onchange="autoSave()"></div>
            </div>
        `).join('');
        document.getElementById('stockContainer').innerHTML = stockHTML;

        const whHTML = products.map(p => `
            <div class="mb-2 pb-2 border-b border-gray-100 last:border-0">
                <div class="wh-grid">
                    <div class="text-xs font-bold ${p.color}">${p.name}</div>
                    <input type="number" id="wh_${p.id}_bag" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á" class="input-field bg-purple-50 text-purple-900 input-wh" onchange="calculateWarehouse()">
                    <input type="number" id="wh_${p.id}_cost" placeholder="‡∏ó‡∏∏‡∏ô/‡∏ñ‡∏∏‡∏á" class="input-field bg-white border-purple-200 input-wh" onchange="calculateWarehouse()">
                </div>
                <div class="flex justify-between text-[10px] text-gray-400 px-2">
                    <span>‡∏´‡∏±‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô: <span id="wh_deduct_${p.id}" class="text-red-500 font-bold">0</span> ‡∏ñ‡∏∏‡∏á</span>
                    <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á: <span id="wh_rem_${p.id}" class="text-green-600 font-bold">0</span> ‡∏ñ‡∏∏‡∏á</span>
                </div>
            </div>
        `).join('');
        document.getElementById('warehouseContainer').innerHTML = whHTML;

        const allInputs = ['shop_name', 'staff_name', 'record_date', 'cash', 'transfer', 'daily_expense', 'waste_dumpling', 'waste_bbq', 'individual_10_count', 'set150_count', 'set250_count', 'set290_count', 'fixed_cost_custom'];
        allInputs.forEach(id => document.getElementById(id).addEventListener('change', autoSave));

        // Logic
        window.isWarehouseCalculated = true; 

        function toggleWarehouseCalculation() {
            window.isWarehouseCalculated = document.getElementById('calc_warehouse_toggle').checked;
            const whInputs = document.querySelectorAll('.input-wh');
            const warehouseContent = document.getElementById('warehouseContent');
            const warehouseDisabled = document.getElementById('warehouseDisabledMsg');
            const cardWarehouse = document.getElementById('cardWarehouse');
            
            if (window.isWarehouseCalculated) {
                whInputs.forEach(el => el.disabled = false);
                warehouseContent.classList.remove('opacity-50', 'pointer-events-none');
                warehouseDisabled.classList.add('hidden');
                cardWarehouse.classList.remove('bg-gray-100');
            } else {
                whInputs.forEach(el => el.disabled = true);
                warehouseContent.classList.add('opacity-50', 'pointer-events-none');
                warehouseDisabled.classList.remove('hidden');
                cardWarehouse.classList.add('bg-gray-100');
            }
        }

        function calculateWarehouse() {
            let totalWhValue = 0;
            products.forEach(p => {
                let whStockBags = getVal(`wh_${p.id}_bag`);
                let whCostPerBag = getVal(`wh_${p.id}_cost`);
                let addBag = getVal(`${p.id}_add_bag`);
                let addUnit = getVal(`${p.id}_add_unit`);
                let addTotalBags = addBag + (addUnit / p.unit);
                
                let remainingBags = Math.max(0, whStockBags - addTotalBags);
                let remainingValue = remainingBags * whCostPerBag;
                document.getElementById(`wh_deduct_${p.id}`).innerText = addTotalBags > 0 ? addTotalBags.toFixed(2) : "0";
                document.getElementById(`wh_rem_${p.id}`).innerText = remainingBags.toFixed(2);
                totalWhValue += remainingValue;
            });
            document.getElementById('wh_total_value').innerText = `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°: ${totalWhValue.toLocaleString()} ‡∏ø`;
            autoSave();
            return totalWhValue;
        }

        function autoSave() {
            const data = {};
            products.forEach(p => {
                ['prev', 'add', 'end'].forEach(type => {
                    data[`${p.id}_${type}_bag`] = document.getElementById(`${p.id}_${type}_bag`).value;
                    data[`${p.id}_${type}_unit`] = document.getElementById(`${p.id}_${type}_unit`).value;
                });
                data[`wh_${p.id}_bag`] = document.getElementById(`wh_${p.id}_bag`).value;
                data[`wh_${p.id}_cost`] = document.getElementById(`wh_${p.id}_cost`).value;
            });
            allInputs.forEach(id => data[id] = document.getElementById(id).value);
            data['fixed_cost_select'] = document.getElementById('fixed_cost_select').value;
            data['calc_warehouse_toggle'] = document.getElementById('calc_warehouse_toggle').checked;

            localStorage.setItem('shop_v22_1_data', JSON.stringify(data));
            document.getElementById('saveStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Auto " + new Date().toLocaleTimeString();
        }

        function loadAutoSave() {
            const saved = localStorage.getItem('shop_v22_1_data');
            if(saved) {
                const data = JSON.parse(saved);
                products.forEach(p => {
                    ['prev', 'add', 'end'].forEach(type => {
                        setVal(`${p.id}_${type}_bag`, data[`${p.id}_${type}_bag`]);
                        setVal(`${p.id}_${type}_unit`, data[`${p.id}_${type}_unit`]);
                    });
                    setVal(`wh_${p.id}_bag`, data[`wh_${p.id}_bag`]);
                    setVal(`wh_${p.id}_cost`, data[`wh_${p.id}_cost`]);
                });
                allInputs.forEach(id => setVal(id, data[id]));
                if(data['fixed_cost_select']) {
                    document.getElementById('fixed_cost_select').value = data['fixed_cost_select'];
                    toggleCustomFixedCost();
                }
                if (data['calc_warehouse_toggle'] !== undefined) {
                    document.getElementById('calc_warehouse_toggle').checked = data['calc_warehouse_toggle'];
                }
                calculateWarehouse();
                toggleWarehouseCalculation();
            }
        }

        function clearAllData() {
            if(confirm('‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                localStorage.removeItem('shop_v22_1_data');
                localStorage.removeItem('shop_history');
                location.reload();
            }
        }

        function getApiKey() { return localStorage.getItem('gemini_api_key'); }
        function getScriptUrl() { 
            return localStorage.getItem('google_script_url') || DEFAULT_SCRIPT_URL; 
        }
        
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const url = document.getElementById('scriptUrlInput').value.trim();
            if(key) localStorage.setItem('gemini_api_key', key);
            if(url) localStorage.setItem('google_script_url', url);
            document.getElementById('keyStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß";
            document.getElementById('apiKeyWarning').classList.add('hidden');
        }
        function toggleSettings() { document.getElementById('settingsArea').classList.toggle('hidden'); }
        
        if(getApiKey()) document.getElementById('apiKeyInput').value = getApiKey();
        document.getElementById('scriptUrlInput').value = getScriptUrl(); 

        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        function updateStatus() {
            const el = document.getElementById('connectionStatus');
            if(navigator.onLine) { el.className = 'status-online'; el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-600 animate-pulse"></span> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'; } 
            else { el.className = 'status-offline'; el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-600"></span> ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'; }
        }

        window.stockData = { base64: null, mime: null };
        window.salesData = { base64: null, mime: null };

        function previewFile(input, type) {
            const imgBox = document.getElementById(type === 'stock' ? 'previewContainerStock' : 'previewContainerSales');
            const img = document.getElementById(type === 'stock' ? 'imgStock' : 'imgSales');
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const tempImg = new Image();
                tempImg.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = tempImg.width;
                    let height = tempImg.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(tempImg, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    img.src = dataUrl;
                    imgBox.style.display = 'block';

                    const base64 = dataUrl.split(',')[1];
                    const mime = 'image/jpeg';
                    if(type === 'stock') window.stockData = { base64, mime }; 
                    else window.salesData = { base64, mime };
                };
                tempImg.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function closeImage(e, type) {
            e.stopPropagation();
            document.getElementById(type === 'stock' ? 'previewContainerStock' : 'previewContainerSales').style.display = 'none';
            if (type === 'stock') { 
                document.getElementById('stock_cam').value = ""; 
                document.getElementById('stock_file').value = ""; 
                window.stockData = { base64: null, mime: null }; 
            } 
            else { 
                document.getElementById('sales_cam').value = ""; 
                document.getElementById('sales_file').value = ""; 
                window.salesData = { base64: null, mime: null }; 
            }
        }

        function closeResult() {
            document.getElementById('resultSection').classList.add('hidden');
            const aiResult = document.getElementById('aiResult');
            if (aiResult) aiResult.classList.add('hidden');
            const btnAskAI = document.getElementById('btnAskAI');
            if (btnAskAI) btnAskAI.classList.remove('hidden');
        }
        function toggleCustomFixedCost() {
            document.getElementById('fixed_cost_custom').classList.toggle('hidden', document.getElementById('fixed_cost_select').value !== 'custom');
            autoSave();
        }
        function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
        
        // Anti-Crash Helper Function
        function safeSetText(id, val) {
            const el = document.getElementById(id);
            if(el) el.innerText = val;
        }

        function setVal(id, val) { 
            const el = document.getElementById(id);
            if(el && val !== null && val !== undefined) el.value = val; 
        }

        let globalData = {};

        function calculateStock(pfx, unitPerBag) {
            let prev = (getVal(pfx+'_prev_bag') * unitPerBag) + getVal(pfx+'_prev_unit');
            let add = (getVal(pfx+'_add_bag') * unitPerBag) + getVal(pfx+'_add_unit');
            let end = (getVal(pfx+'_end_bag') * unitPerBag) + getVal(pfx+'_end_unit');
            return Math.max(0, (prev + add) - end);
        }

        function calculateProfit() {
            let isWarehouseActive = document.getElementById('calc_warehouse_toggle').checked;
            
            let cash = getVal('cash'), transfer = getVal('transfer'), daily = getVal('daily_expense');
            let actual_rev = cash + transfer + daily;

            let fixed = document.getElementById('fixed_cost_select').value === 'custom' ? getVal('fixed_cost_custom') : parseFloat(document.getElementById('fixed_cost_select').value);
            
            let s = calculateStock('s', 24);
            let c = calculateStock('c', 32);
            let p = calculateStock('p', 32);
            let v = calculateStock('v', 30);
            let bb = calculateStock('bb', 20);
            let b = calculateStock('b', 20);

            let totalUsageDump = s + c + p + v;
            let totalUsageBBQ = bb + b;

            let wasteDump = getVal('waste_dumpling');
            let wasteBBQ = getVal('waste_bbq');

            let netSoldDump = Math.max(0, totalUsageDump - wasteDump);
            let netSoldBBQ = Math.max(0, totalUsageBBQ - wasteBBQ);

            let individual10 = getVal('individual_10_count');
            let set150 = getVal('set150_count'), set290 = getVal('set290_count'), set250 = getVal('set250_count');

            let revenueDump = netSoldDump * 13;
            let revenueBBQ = netSoldBBQ * 50;

            let adj_set250 = set250 * -10;
            let adj_set150 = set150 * 20;
            let adj_set290 = set290 * 30;
            let adj_individual = individual10 * -3;
            let adjustment = adj_set250 + adj_set150 + adj_set290 + adj_individual;

            let expected = revenueDump + revenueBBQ + adjustment;

            let costGoodsDump = totalUsageDump * 6.5;
            let costGoodsBBQ = totalUsageBBQ * 24;
            let totalCostAll = costGoodsDump + costGoodsBBQ + fixed + daily;

            let profit = actual_rev - totalCostAll;
            let diff = actual_rev - expected; 

            let statusText = "‡∏¢‡∏≠‡∏î‡∏ï‡∏£‡∏á";
            if (Math.abs(diff) >= 50) statusText = diff > 0 ? "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô" : "‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢";

            let totalWhValue = 0;
            let whDetails = [];
            let whReportList = "";
            
            if (isWarehouseActive) {
                totalWhValue = calculateWarehouse();
                
                 products.forEach(p => {
                    let whStockBags = getVal(`wh_${p.id}_bag`);
                    let whCostPerBag = getVal(`wh_${p.id}_cost`);
                    let addBag = getVal(`${p.id}_add_bag`);
                    let addUnit = getVal(`${p.id}_add_unit`);
                    let addTotalBags = addBag + (addUnit / p.unit);
                    
                    let remainingBags = Math.max(0, whStockBags - addTotalBags);
                    let remainingValue = remainingBags * whCostPerBag;
                    whDetails.push({ name: p.name, rem: remainingBags, cost: whCostPerBag, val: remainingValue });
                });
                whDetails.forEach(i => {
                    whReportList += `<div class="flex justify-between"><span>${i.name}:</span> <span>${i.rem.toFixed(2)} ‡∏ñ‡∏∏‡∏á</span></div>`;
                });
                safeSetText('res_wh_list', whReportList); // Use HTML content
                document.getElementById('res_wh_list').innerHTML = whReportList; // Re-apply innerHTML safely
                safeSetText('res_wh_value', totalWhValue.toLocaleString());
                document.getElementById('wh_summary_box').classList.remove('hidden');
                document.getElementById('sales_summary_box').classList.remove('hidden');
                document.getElementById('audit_box').classList.remove('hidden');
                
                document.getElementById('cost_summary_box').classList.remove('hidden');

            } else {
                profit = actual_rev - totalCostAll; 
                statusText = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å";
                document.getElementById('wh_summary_box').classList.add('hidden');
                document.getElementById('cost_summary_box').classList.remove('hidden');
            }

            globalData = { 
                actual_rev, profit, diff, 
                items: {
                    usage_dump: totalUsageDump, usage_bbq: totalUsageBBQ,
                    sold_dump: netSoldDump, sold_bbq: netSoldBBQ, 
                    waste_dump: wasteDump, waste_bbq: wasteBBQ,
                    individual: individual10,
                    s, c, p, v, bb, b
                },
                costs: { 
                    goods_dump: costGoodsDump, goods_bbq: costGoodsBBQ, 
                    fixed: fixed, daily: daily, total: totalCostAll 
                },
                warehouse: { totalVal: totalWhValue, html: whReportList, details: whDetails },
                statusText: statusText,
                isWarehouseActive: isWarehouseActive,
                adj_val: adjustment
            };
            
            document.getElementById('resultSection').classList.remove('hidden');
            
            safeSetText('res_expected', expected.toLocaleString());
            safeSetText('res_actual', actual_rev.toLocaleString());
            safeSetText('res_diff', diff.toLocaleString());
            safeSetText('audit_msg', statusText);

            safeSetText('res_profit', profit.toLocaleString() + " ‡∏ø");
            
            safeSetText('res_total_cost', totalCostAll.toLocaleString() + " ‡∏ø");
            safeSetText('res_count_dump_total', totalUsageDump);
            safeSetText('res_count_bbq_total', totalUsageBBQ);
            safeSetText('res_cost_dump', costGoodsDump.toLocaleString());
            safeSetText('res_cost_bbq', costGoodsBBQ.toLocaleString());
            safeSetText('res_cost_fixed', fixed.toLocaleString());
            safeSetText('res_cost_daily', daily.toLocaleString());
            safeSetText('res_total_other_cost', (fixed + daily).toLocaleString() + " ‡∏ø");
            
            safeSetText('res_raw_cash', actual_rev.toLocaleString());
            safeSetText('res_cash_only', getVal('cash').toLocaleString());
            safeSetText('res_adj_val', adjustment.toLocaleString());
            
            safeSetText('res_total_dumplings', netSoldDump.toLocaleString());
            safeSetText('res_total_bbq', netSoldBBQ.toLocaleString());
            
            safeSetText('res_sold_dump', netSoldDump);
            safeSetText('res_waste_dump', wasteDump);
            safeSetText('res_usage_dump', totalUsageDump);

            safeSetText('res_sold_bbq', netSoldBBQ);
            safeSetText('res_waste_bbq', wasteBBQ);
            safeSetText('res_usage_bbq', totalUsageBBQ);

            let costPct = (totalCostAll / (totalCostAll + Math.max(0,profit))) * 100;
            if(profit < 0) costPct = 100;
            document.getElementById('chart_cost_bar').style.width = `${costPct}%`;
            document.getElementById('chart_profit_bar').style.width = `${100-costPct}%`;
            safeSetText('chart_cost_pct', `${Math.round(costPct)}%`);
            safeSetText('chart_profit_pct', `${Math.round(100-costPct)}%`);

            safeSetText('print_shop_name', document.getElementById('shop_name').value || "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏ã‡πà‡∏≤");
            const dateStr = new Date(document.getElementById('record_date').value).toLocaleDateString('th-TH');
            safeSetText('print_date_staff', `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${document.getElementById('staff_name').value || '-'}`);

            let box = document.getElementById('audit_box');
            if(Math.abs(diff) < 50) { 
                box.className = "p-3 rounded-lg border-2 audit-pass"; 
                document.getElementById('res_diff').className = "text-xl font-bold text-green-700";
            } else if(diff > 0) { 
                box.className = "p-3 rounded-lg border-2 bg-blue-50 border-blue-200 text-blue-700"; 
                document.getElementById('res_diff').className = "text-xl font-bold text-blue-700";
            } else { 
                box.className = "p-3 rounded-lg border-2 audit-fail"; 
                document.getElementById('res_diff').className = "text-xl font-bold text-red-700";
            }
        }

        // ============================================
        // üöÄ NEW FUNCTIONS ADDED FOR EXPORT & HISTORY
        // ============================================

        function exportReport() {
            calculateProfit(); // Ensure data is fresh
            
            const date = document.getElementById('record_date').value;
            const shop = document.getElementById('shop_name').value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            const staff = document.getElementById('staff_name').value || "-";
            
            // Helper to get raw input values for stock
            const getStockStr = (id) => {
                const p_bag = document.getElementById(`${id}_prev_bag`).value || 0;
                const p_unit = document.getElementById(`${id}_prev_unit`).value || 0;
                const a_bag = document.getElementById(`${id}_add_bag`).value || 0;
                const a_unit = document.getElementById(`${id}_add_unit`).value || 0;
                const e_bag = document.getElementById(`${id}_end_bag`).value || 0;
                const e_unit = document.getElementById(`${id}_end_unit`).value || 0;
                return `‡∏¢‡∏Å‡∏°‡∏≤ ${p_bag}.${p_unit} + ‡πÄ‡∏ï‡∏¥‡∏° ${a_bag}.${a_unit} - ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${e_bag}.${e_unit}`;
            };

            let txt = `=== ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î (Full Report) ===\n`;
            txt += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${date}\n`;
            txt += `‡∏™‡∏≤‡∏Ç‡∏≤: ${shop} | ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${staff}\n`;
            txt += `‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}\n`;
            txt += `========================================\n\n`;

            txt += `[üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô]\n`;
            txt += `+ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏ô‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å: ${getVal('cash').toLocaleString()} ‡∏ö.\n`;
            txt += `+ ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô: ${getVal('transfer').toLocaleString()} ‡∏ö.\n`;
            txt += `+ ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏Å): ${getVal('daily_expense').toLocaleString()} ‡∏ö.\n`;
            txt += `----------------------------------------\n`;
            txt += `> ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á (Net Cash): ${globalData.actual_rev.toLocaleString()} ‡∏ö.\n`;
            txt += `> ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ (Expected): ${parseFloat(document.getElementById('res_expected').innerText.replace(/,/g,'')).toLocaleString()} ‡∏ö.\n`;
            txt += `> ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (Diff): ${globalData.diff > 0 ? '+' : ''}${globalData.diff} ‡∏ö. (${globalData.statusText})\n`;
            txt += `> ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Profit): ${globalData.profit.toLocaleString()} ‡∏ö.\n`;
            txt += `========================================\n\n`;

            txt += `[üìâ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô]\n`;
            txt += `- ‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß: ${globalData.costs.goods_dump.toLocaleString()} ‡∏ö.\n`;
            txt += `- ‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö BBQ: ${globalData.costs.goods_bbq.toLocaleString()} ‡∏ö.\n`;
            txt += `- ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà+‡πÅ‡∏£‡∏á (Fixed): ${globalData.costs.fixed.toLocaleString()} ‡∏ö.\n`;
            txt += `- ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Daily): ${globalData.costs.daily.toLocaleString()} ‡∏ö.\n`;
            txt += `> ‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${globalData.costs.total.toLocaleString()} ‡∏ö.\n`;
            txt += `========================================\n\n`;

            txt += `[üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ & ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢]\n`;
            txt += `ü•ü ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß‡∏£‡∏ß‡∏°: ‡πÉ‡∏ä‡πâ ${globalData.items.usage_dump} --> ‡∏Ç‡∏≤‡∏¢ ${globalData.items.sold_dump} | ‡πÄ‡∏™‡∏µ‡∏¢ ${globalData.items.waste_dump}\n`;
            txt += `üç¢ BBQ‡∏£‡∏ß‡∏°:  ‡πÉ‡∏ä‡πâ ${globalData.items.usage_bbq} --> ‡∏Ç‡∏≤‡∏¢ ${globalData.items.sold_bbq} | ‡πÄ‡∏™‡∏µ‡∏¢ ${globalData.items.waste_bbq}\n`;
            txt += `\n[‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î Set/‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô]\n`;
            txt += `- ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å (10‡∏ö.): ${getVal('individual_10_count')} ‡∏ï‡∏±‡∏ß\n`;
            txt += `- Set 150: ${getVal('set150_count')} ‡∏ä‡∏∏‡∏î\n`;
            txt += `- Set 250: ${getVal('set250_count')} ‡∏ä‡∏∏‡∏î\n`;
            txt += `- Set 290: ${getVal('set290_count')} ‡∏ä‡∏∏‡∏î\n`;
            txt += `========================================\n\n`;

            txt += `[üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)]\n`;
            products.forEach(p => {
                // Calculate usage for this item specifically
                // Note: globalData.items.s/c/p etc holds the usage count
                let usage = globalData.items[p.id]; 
                txt += `${p.name}: ${getStockStr(p.id)} = ‡πÉ‡∏ä‡πâ ${usage}\n`;
            });
            txt += `========================================\n\n`;

            if(globalData.isWarehouseActive) {
                txt += `[üè≠ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Warehouse)]\n`;
                if(globalData.warehouse.details.length > 0) {
                    globalData.warehouse.details.forEach(w => {
                        txt += `- ${w.name}: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${w.rem.toFixed(2)} ‡∏ñ‡∏∏‡∏á (${w.val.toLocaleString()} ‡∏ö.)\n`;
                    });
                    txt += `> ‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${globalData.warehouse.totalVal.toLocaleString()} ‡∏ö.\n`;
                } else {
                    txt += `- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n`;
                }
                txt += `========================================\n`;
            }

            const blob = new Blob(['\uFEFF' + txt], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `FullReport_${shop}_${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function saveToHistory() {
            calculateProfit(); // Update globalData
            const date = document.getElementById('record_date').value;
            const shop = document.getElementById('shop_name').value || "‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            const staff = document.getElementById('staff_name').value || "-";
            
            let history = JSON.parse(localStorage.getItem('shop_history') || "[]");
            
            // Remove old entry for same date/shop to prevent dupes
            history = history.filter(h => !(h.date === date && h.shop === shop));
            
            const newEntry = {
                id: Date.now(),
                date: date,
                shop: shop,
                staff: staff,
                data: globalData,
                timestamp: new Date().toLocaleString('th-TH')
            };
            
            history.unshift(newEntry); // Add to top
            if(history.length > 30) history.pop(); // Keep last 30
            
            localStorage.setItem('shop_history', JSON.stringify(history));
            
            const btn = document.getElementById('btnSaveHistory');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
            btn.classList.remove('bg-emerald-600');
            btn.classList.add('bg-gray-500');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.add('bg-emerald-600');
                btn.classList.remove('bg-gray-500');
            }, 2000);
        }

        function openHistory() {
            document.getElementById('historySection').classList.remove('hidden');
            showHistoryList();
        }

        function showHistoryList() {
            document.getElementById('historyListContainer').classList.remove('hidden');
            document.getElementById('historyDetailContainer').classList.add('hidden');
            
            const history = JSON.parse(localStorage.getItem('shop_history') || "[]");
            const container = document.getElementById('historyListContainer');
            const empty = document.getElementById('emptyHistory');
            
            container.innerHTML = "";
            
            if(history.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            
            history.forEach(h => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 rounded border border-gray-200 cursor-pointer hover:bg-indigo-50 transition";
                div.onclick = () => showHistoryDetail(h);
                
                let statusColor = h.data.diff === 0 ? "text-green-600" : "text-red-500";
                
                div.innerHTML = `
                    <div class="flex justify-between font-bold text-sm">
                        <span>${h.date}</span>
                        <span class="text-indigo-700">${h.data.profit.toLocaleString()} ‡∏ø</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>${h.shop} (${h.staff})</span>
                        <span class="${statusColor}">${h.data.statusText}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function showHistoryDetail(h) {
            document.getElementById('historyListContainer').classList.add('hidden');
            document.getElementById('historyDetailContainer').classList.remove('hidden');
            
            const content = document.getElementById('historyDetailContent');
            content.innerHTML = `
                <div class="bg-white p-3 border rounded shadow-sm text-sm">
                    <h3 class="font-bold text-lg text-center border-b pb-2 mb-2">${h.shop}</h3>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${h.date}</div>
                        <div>üë§ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${h.staff}</div>
                    </div>
                    <div class="bg-gray-100 p-2 rounded mb-2">
                         <div class="flex justify-between font-bold"><span>üí∞ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span> <span class="text-green-600">${h.data.profit.toLocaleString()}</span></div>
                         <div class="flex justify-between text-xs"><span>üíµ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á:</span> <span>${h.data.actual_rev.toLocaleString()}</span></div>
                         <div class="flex justify-between text-xs"><span>üìâ ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°:</span> <span>${h.data.costs.total.toLocaleString()}</span></div>
                    </div>
                    <div class="text-xs space-y-1">
                        <p><strong>‡∏™‡∏ï‡πá‡∏≠‡∏Å:</strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ${h.data.items.usage_dump}, ‡πÉ‡∏ä‡πâ BBQ ${h.data.items.usage_bbq}</p>
                        <p><strong>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${h.data.statusText} (${h.data.diff})</p>
                    </div>
                </div>
            `;
        }

        async function sendToGoogleSheet() {
            calculateProfit();
            const btn = document.getElementById('btnSendSheet');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
            btn.disabled = true;

            const payload = {
                date: document.getElementById('record_date').value,
                shop: document.getElementById('shop_name').value,
                staff: document.getElementById('staff_name').value,
                profit: globalData.profit,
                actual_revenue: globalData.actual_rev,
                total_cost: globalData.costs.total,
                diff: globalData.diff,
                status: globalData.statusText,
                timestamp: new Date().toISOString()
            };

            try {
                const scriptUrl = getScriptUrl();
                await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                btn.innerHTML = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
            } catch (e) {
                console.error(e);
                alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
                btn.innerHTML = "‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function extractDataFromImage() {
            const apiKey = getApiKey();
            if (!apiKey) return alert("‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            
            if (!window.stockData.base64 && !window.salesData.base64) {
                 return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô AI");
            }

            document.getElementById('btnAutoFill').classList.add('hidden');
            document.getElementById('fillLoading').classList.remove('hidden');
            
            try {
                const contentParts = [{ text: `
                    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ 
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)
                    
                    ‡∏ñ‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å (S, C, P, V, BBQ, B):
                    - S = ‡∏Å‡∏∏‡πâ‡∏á, C = ‡πÑ‡∏Å‡πà, P = ‡∏´‡∏°‡∏π, V = ‡∏ú‡∏±‡∏Å, BBQ = ‡∏ö‡∏≤‡∏£‡πå‡∏ö‡∏µ‡∏Ñ‡∏¥‡∏ß, B = ‡∏û‡∏£‡∏¥‡∏Å
                    - prev_bag, prev_unit = ‡∏¢‡∏Å‡∏°‡∏≤ (‡∏ñ‡∏∏‡∏á/‡∏ï‡∏±‡∏ß)
                    - add_bag, add_unit = ‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡∏∏‡∏á/‡∏ï‡∏±‡∏ß)
                    - end_bag, end_unit = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ñ‡∏∏‡∏á/‡∏ï‡∏±‡∏ß)
                    
                    ‡∏ñ‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢/‡πÄ‡∏á‡∏¥‡∏ô:
                    - cash = ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÉ‡∏ô‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏Å
                    - transfer = ‡∏¢‡∏≠‡∏î‡πÇ‡∏≠‡∏ô
                    - daily_expense = ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                    - waste_dumpling = ‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß
                    - waste_bbq = ‡πÄ‡∏™‡∏µ‡∏¢ BBQ
                    - individual_10_count = ‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞ 10 ‡∏ö‡∏≤‡∏ó (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    - set150_count = ‡∏ä‡∏∏‡∏î 150
                    - set250_count = ‡∏ä‡∏∏‡∏î 250
                    - set290_count = ‡∏ä‡∏∏‡∏î 290
                    
                    JSON Keys required: 
                    cash, transfer, daily_expense, waste_dumpling, waste_bbq, individual_10_count, 
                    set150_count, set250_count, set290_count,
                    s_prev_bag, s_prev_unit, s_add_bag, s_add_unit, s_end_bag, s_end_unit,
                    c_prev_bag, c_prev_unit, c_add_bag, c_add_unit, c_end_bag, c_end_unit,
                    p_prev_bag, p_prev_unit, p_add_bag, p_add_unit, p_end_bag, p_end_unit,
                    v_prev_bag, v_prev_unit, v_add_bag, v_add_unit, v_end_bag, v_end_unit,
                    bb_prev_bag, bb_prev_unit, bb_add_bag, bb_add_unit, bb_end_bag, bb_end_unit,
                    b_prev_bag, b_prev_unit, b_add_bag, b_add_unit, b_end_bag, b_end_unit.

                    Use 0 for missing values. Return ONLY valid JSON string.
                ` }];
                
                if (window.stockData.base64) {
                    contentParts.push({ inlineData: { mimeType: window.stockData.mime, data: window.stockData.base64 } });
                }
                if (window.salesData.base64) {
                    contentParts.push({ inlineData: { mimeType: window.salesData.mime, data: window.salesData.base64 } });
                }

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ role: "user", parts: contentParts }] })
                });

                const data = await res.json();
                
                if(data.error) {
                      throw new Error(data.error.message);
                }
                
                let txt = data.candidates[0].content.parts[0].text;
                const jsonMatch = txt.match(/\{[\s\S]*\}/);
                if (jsonMatch) txt = jsonMatch[0];
                
                const j = JSON.parse(txt);

                const moneyFields = ['cash','transfer','daily_expense', 'waste_dumpling', 'waste_bbq', 'individual_10_count', 'set150_count', 'set290_count', 'set250_count'];
                moneyFields.forEach(k => {
                    if (j[k] !== undefined) setVal(k, j[k]);
                });

                const prodIds = ['s','c','p','v','bb','b'];
                prodIds.forEach(i => {
                    ['prev','add','end'].forEach(t => {
                        if (j[`${i}_${t}_bag`] !== undefined) setVal(`${i}_${t}_bag`, j[`${i}_${t}_bag`]);
                        if (j[`${i}_${t}_unit`] !== undefined) setVal(`${i}_${t}_unit`, j[`${i}_${t}_unit`]);
                    });
                });
                
                alert("‚úÖ AI ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                autoSave();

            } catch(e) { 
                console.error(e); 
                let msg = e.message;
                if (msg.includes("API key")) {
                    msg = "API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)";
                    document.getElementById('settingsArea').classList.remove('hidden');
                    document.getElementById('apiKeyInput').focus();
                }
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î AI: " + msg); 
            } finally {
                document.getElementById('fillLoading').classList.add('hidden');
                document.getElementById('btnAutoFill').classList.remove('hidden');
            }
        }

        async function askGemini() {
            const apiKey = getApiKey();
            if (!apiKey) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key");
            
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiResult').classList.add('hidden');
            document.getElementById('btnAskAI').classList.add('hidden');

            try {
                calculateProfit(); // Update Data
                
                const prompt = `
                    ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ:
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${JSON.stringify(globalData)}
                    
                    ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ 3 ‡∏Ç‡πâ‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                `;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                
                document.getElementById('aiResult').innerHTML = marked.parse(text);
                document.getElementById('aiResult').classList.remove('hidden');

            } catch(e) {
                alert("AI Error: " + e.message);
            } finally {
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('btnAskAI').classList.remove('hidden');
            }
        }

        loadAutoSave();
    </script>
</body>
</html>
